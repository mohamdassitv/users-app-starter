<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Task 4 — Shift Alert Correlation & Handover</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="/styles.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.umd.js"></script>
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.css" />
<style>
.page{max-width:1280px;margin:0 auto;padding:24px 40px 120px;}
.hero-box{background:linear-gradient(150deg,#4f0028,#831843,#be185d,#db2777);background-size:240% 240%;animation:hbPulse 16s ease infinite;color:#ffeef7;border:1px solid #fb6fbe;border-radius:30px;padding:38px 44px 40px;position:relative;box-shadow:0 18px 50px -14px rgba(190,24,93,.55),0 6px 18px -6px rgba(190,24,93,.5);margin:0 0 60px;overflow:hidden;}
.hero-box:before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 80% 22%,rgba(255,192,220,.42),transparent 65%);mix-blend-mode:screen;pointer-events:none;}
.hero-box h1{margin:0 0 12px;font-size:40px;letter-spacing:.05em;}
.hero-desc{margin:0;font-size:15px;line-height:1.55;font-weight:500;max-width:960px;}
.tabs-bar{display:flex;flex-wrap:wrap;gap:12px;margin:0 0 28px;}
.tab-btn{background:#fff;border:1px solid #fbcfe8;color:#831843;padding:10px 18px 9px;font-size:14px;font-weight:600;border-radius:14px;cursor:pointer;letter-spacing:.4px;display:inline-flex;align-items:center;gap:8px;position:relative;transition:.18s;}
.tab-btn.active{background:linear-gradient(135deg,#f472b6,#ec4899,#db2777);color:#fff;box-shadow:0 6px 18px -6px rgba(236,72,153,.5);}
.tab-btn:not(.active):hover{background:#fff5fa;}
.panels{border:1px solid #fbcfe8;background:#fffafb;border-radius:30px;padding:34px 40px 46px;position:relative;box-shadow:0 6px 28px -12px rgba(219,39,119,.35),0 2px 6px -2px rgba(0,0,0,.08);} 
.panel{display:none;animation:fadeSlide .4s ease;}
.panel.active{display:block;}
.panel h2{margin:0 0 14px;font-size:22px;letter-spacing:.5px;color:#0f172a;}
.small-hint{font-size:12px;color:#475569;margin:0 0 16px;}
textarea,input[type=text]{font-family:ui-monospace,Menlo,Consolas,monospace;}
.field-set{display:flex;flex-direction:column;gap:18px;margin:0 0 28px;}
.field{display:flex;flex-direction:column;gap:6px;}
.field label{font-size:12px;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:#831843;}
.text-box, .mini-box{width:100%;border:1px solid #cbd5e1;border-radius:14px;padding:12px 14px;font-size:13px;background:#f8fafc;resize:vertical;min-height:120px;line-height:1.5;transition:border-color .18s,box-shadow .18s;}
.text-box:focus,.mini-box:focus{outline:none;border-color:#ec4899;box-shadow:0 0 0 3px rgba(236,72,153,.35);background:#fff;}
.mini-box{min-height:56px;}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;}
.alert-table{width:100%;border-collapse:collapse;font-size:13px;margin:10px 0 0;}
.alert-table th, .alert-table td{border:1px solid #e2e8f0;padding:6px 8px;text-align:left;vertical-align:top;}
.alert-table th{background:#ffe4ef;color:#581c39;font-weight:700;font-size:11.5px;letter-spacing:.1em;text-transform:uppercase;}
.alert-row{cursor:pointer;}
.alert-row:hover{background:#fff0f7;}
.status-pill{display:inline-block;padding:2px 8px 1px;font-size:11px;font-weight:600;border-radius:999px;letter-spacing:.05em;}
.pill-open{background:#dc2626;color:#fff;}
.pill-investigating{background:#f59e0b;color:#581c1c;}
.pill-mitigated{background:#059669;color:#fff;}
.sev-pill{display:inline-block;padding:2px 8px 1px;font-size:10px;font-weight:700;border-radius:8px;letter-spacing:.06em;}
.sev-P1{background:#7f1d1d;color:#fff;}
.sev-P2{background:#b91c1c;color:#fff;}
.sev-P3{background:#f59e0b;color:#581c1c;}
.sev-P4{background:#10b981;color:#053321;}
.sev-P5{background:#64748b;color:#fff;}
.inline-btn{background:#fff;color:#be185d;border:1px solid #f9a8d4;padding:6px 12px;border-radius:10px;font-size:12px;font-weight:600;cursor:pointer;transition:.18s;}
.inline-btn:hover{background:#fff0f7;border-color:#ec4899;}
.actions{display:flex;flex-wrap:wrap;gap:16px;margin-top:16px;}
.btn-primary{background:linear-gradient(135deg,#f472b6,#ec4899,#db2777);color:#fff;font-weight:600;border:none;padding:14px 28px;border-radius:16px;font-size:15px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;letter-spacing:.4px;box-shadow:0 6px 20px -8px rgba(236,72,153,.5),0 2px 4px -1px rgba(0,0,0,.35);transition:transform .18s, box-shadow .18s;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 12px 30px -12px rgba(236,72,153,.6),0 4px 8px -3px rgba(0,0,0,.28);}
.btn-primary:active{transform:translateY(0);}
.btn-ghost{background:#fff;color:#be185d;border:1px solid #f9a8d4;padding:12px 22px;border-radius:14px;font-weight:500;cursor:pointer;font-size:14px;transition:background .18s,border-color .18s,box-shadow .18s,color .18s;}
.btn-ghost:hover{background:#fff0f7;border-color:#f472b6;color:#9d174d;}
.save-state{font-size:12px;color:#64748b;}
.save-state.dirty{color:#b45309;}
.save-state.saved{color:#059669;}
.timeline-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px;}
.timeline-item{background:#fff;border:1px solid #fbcfe8;padding:10px 14px;border-radius:14px;display:flex;flex-direction:column;gap:4px;position:relative;}
.timeline-item:before{content:"";position:absolute;left:-14px;top:18px;width:10px;height:10px;border-radius:50%;background:linear-gradient(145deg,#f472b6,#ec4899,#db2777);box-shadow:0 0 0 4px #ffe4ef;}
.tmeta{font-size:11px;color:#475569;display:flex;gap:12px;flex-wrap:wrap;}
.tag{background:#ffe4ef;color:#831843;padding:2px 8px;border-radius:8px;font-size:11px;font-weight:600;letter-spacing:.05em;}
.code-block{font-family:ui-monospace,Consolas,Menlo,monospace;background:#0f172a;color:#fbcfe8;padding:10px 12px;border-radius:10px;overflow:auto;font-size:12px;line-height:1.4;}
.badge-inline{display:inline-block;background:#ffe4ef;color:#9d174d;padding:3px 8px 2px;border-radius:999px;font-size:11px;font-weight:700;letter-spacing:.12em;margin-left:6px;}
.flex-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
.counter-box{display:flex;gap:18px;flex-wrap:wrap;margin:6px 0 16px;}
.counter{background:#fff;border:1px solid #fbcfe8;padding:12px 16px 11px;border-radius:16px;font-size:12px;font-weight:600;letter-spacing:.08em;color:#831843;box-shadow:0 2px 6px -2px rgba(219,39,119,.25);} 
.export-hint{font-size:11px;margin-top:6px;}
/* Tenants table specific */
.tenants-header-row{display:flex;align-items:flex-end;justify-content:space-between;gap:20px;flex-wrap:wrap;margin:0 0 14px;}
.tenants-search-box{border:1px solid #cbd5e1;border-radius:12px;padding:10px 14px;font-size:13px;width:320px;background:#fff;}
.tenants-search-box:focus{outline:none;border-color:#0ea5e9;box-shadow:0 0 0 3px rgba(14,165,233,.25);} 
.tenants-summary{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0 12px;}
.ten-chip{background:#f1f5f9;color:#0f172a;font-size:11px;font-weight:600;padding:6px 10px 5px;border-radius:999px;letter-spacing:.05em;border:1px solid #e2e8f0;}
.tenants-table-wrap{max-width:100%;overflow:auto;border:1px solid #e5e7eb;border-radius:18px;background:#fff;}
table.tenants-table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px;}
table.tenants-table thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #e5e7eb;font-size:11px;text-transform:uppercase;letter-spacing:.08em;font-weight:700;color:#475569;padding:10px 12px;text-align:left;cursor:pointer;user-select:none;}
table.tenants-table thead th.sortable:hover{background:#eef6fb;}
table.tenants-table tbody td{padding:10px 12px;border-bottom:1px solid #f1f5f9;vertical-align:middle;color:#0f172a;}
table.tenants-table tbody tr:nth-child(even){background:#fcfdff;}
table.tenants-table tbody tr:hover{background:#f1faff;}
.mono{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12.5px;}
.tenant-link{color:#0ea5e9;text-decoration:none;font-weight:600;}
.tenant-link:hover{text-decoration:underline;}
.inst-pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:600;padding:4px 10px 4px;border-radius:999px;background:#f1f5f9;border:1px solid #e2e8f0;line-height:1;}
.inst-dot{width:8px;height:8px;border-radius:50%;background:#22c55e;}
.inst-ok .inst-dot{background:#22c55e;}
.inst-warn .inst-dot{background:#f59e0b;}
.inst-down .inst-dot{background:#ef4444;}
.inst-ok{color:#15803d;}
.inst-warn{color:#b45309;}
.inst-down{color:#b91c1c;}
.hibernated-status{color:#475569;font-weight:600;}
.hibernated-status a{margin-left:6px;font-size:11px;color:#0ea5e9;text-decoration:none;}
.hibernated-status a:hover{text-decoration:underline;}
.pagination-bar{display:flex;align-items:center;justify-content:flex-end;gap:16px;padding:14px 4px 0;font-size:12px;color:#475569;flex-wrap:wrap;}
.pagination-bar select{border:1px solid #cbd5e1;border-radius:10px;padding:6px 10px;font-size:12px;background:#fff;}
.pagination-bar button{background:#fff;border:1px solid #cbd5e1;color:#0f172a;font-size:12px;font-weight:600;padding:6px 12px;border-radius:10px;cursor:pointer;}
.pagination-bar button:disabled{opacity:.4;cursor:not-allowed;}
.empty-state{padding:40px 0;text-align:center;font-size:13px;color:#64748b;}
.sort-ind{font-size:10px;margin-left:4px;color:#475569;}
/* Detail drawer */
#alertDetail{margin-top:24px;border:1px solid #fbcfe8;background:#fff;border-radius:26px;padding:26px 30px 30px;box-shadow:0 4px 24px -10px rgba(219,39,119,.35),0 1px 4px -1px rgba(0,0,0,.12);display:none;}
#alertDetail.active{display:block;animation:fadeSlide .35s ease;}
#alertDetail h3{margin:0 0 10px;font-size:20px;letter-spacing:.5px;color:#0f172a;}
.kv-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px 26px;margin:14px 0 8px;font-size:12px;}
.kv-item{display:flex;flex-direction:column;gap:2px;background:#fffafb;border:1px solid #f1d1e6;padding:10px 12px;border-radius:14px;}
.kv-item span.key{font-size:10px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:#831843;}
.kv-item span.val{font-family:ui-monospace,Menlo,Consolas,monospace;word-break:break-all;}
.detail-meta{font-size:11px;color:#475569;margin:8px 0 14px;}
.detail-section{margin:18px 0 0;}
.close-detail{position:absolute;top:12px;right:12px;background:#fff;color:#be185d;border:1px solid #f9a8d4;padding:6px 10px;border-radius:10px;font-size:12px;font-weight:600;cursor:pointer;}
.close-detail:hover{background:#fff0f7;}
@keyframes fadeSlide{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
@keyframes hbPulse{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
@media (max-width:860px){.panels{padding:26px 26px 34px;border-radius:26px;} .hero-box{padding:30px 30px 32px;} .tabs-bar{gap:8px;} }
</style>
</head>
<body>
<header class="site-header" id="siteHeader">
  <div class="brand" style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="location.href='/tasks.html'">
    <img src="/logo.svg" alt="Logo" class="logo-img">
    <span class="brand-hacker">CHECK POINT</span>
  </div>
  <a href="/tasks.html" style="display:flex;align-items:center;gap:6px;padding:8px 16px;background:rgba(6,78,59,0.9);color:#86efac;text-decoration:none;border-radius:8px;font-size:14px;font-weight:600;border:1px solid #86efac;transition:all 0.3s;" onmouseover="this.style.background='#047857';this.style.color='#fff'" onmouseout="this.style.background='rgba(6,78,59,0.9)';this.style.color='#86efac'">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    Main Tasks
  </a>
</header>
<main class="page fade-in">
  <section class="hero-box">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h1>Task 3 — Shift Alert Correlation & Handover</h1>
        <p class="hero-desc">Scenario: You are in the <strong>middle of an ongoing shift</strong>. A noisy burst of alerts has just landed in the last few minutes while other engineers are tied up. You have to rapidly: isolate the first alert to tackle, articulate why, collapse duplicates/noise, map dependencies, and outline impact — all while preparing a succinct handover for the next shift. Work the panels in order; do not assume any alert text is trustworthy without validation.<span class="badge-inline">Critical</span></p>
      </div>
      <button onclick="resetGateway()" style="background:#dc2626;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;white-space:nowrap;box-shadow:0 2px 8px rgba(220,38,38,0.3);font-size:14px;">Reset Gateway</button>
    </div>
    <!-- Progress Bar -->
    <div style="margin-top:20px;background:#f1f5f9;border:1px solid #cbd5e1;border-radius:12px;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-size:13px;font-weight:600;color:#0f172a;">Progress</span>
        <span id="progressText" style="font-size:12px;color:#64748b;">0/4 Questions Saved</span>
      </div>
      <div style="background:#e2e8f0;border-radius:8px;height:12px;overflow:hidden;">
        <div id="progressBar" style="background:linear-gradient(90deg,#10b981,#059669);height:100%;width:0%;transition:width 0.5s ease;"></div>
      </div>
    </div>
  </section>
  <div class="tabs-bar" role="tablist">
    <button class="tab-btn active" data-tab="alerts" role="tab" aria-selected="true">Active Alerts</button>
    <button class="tab-btn" data-tab="portal" role="tab" aria-selected="false" style="background:linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);color:#fff;">Infinity Portal</button>
  </div>
  <section class="panels">
    <!-- Active Alerts Panel -->
    <div class="panel active" id="panel-alerts" data-panel="alerts">
      <h2>Active Alerts (Static)</h2>
      <p class="small-hint">Static snapshot of current shift alerts. Click a row for full details (disk usage P1 has expanded metadata). No add/edit in this mode.</p>
      <div class="counter-box">
        <div class="counter" id="ctrTotal">TOTAL: 0</div>
        <div class="counter" id="ctrP1">P1: 0</div>
        <div class="counter" id="ctrP2P3">P2/P3: 0</div>
        <div class="counter" id="ctrLower">P4/P5: 0</div>
      </div>
      <table class="alert-table" aria-label="Static shift alerts">
        <thead><tr><th>Product</th><th>Priority</th><th>Alert</th><th>Context</th><th>Opened</th><th>More Info</th><th>Playbooks</th></tr></thead>
        <tbody id="alertsBody"></tbody>
      </table>
      <div id="alertDetail" aria-live="polite"></div>
      <div id="prioritizationBlock" style="margin-top:34px;">
        <div style="background:#dcfce7;border:1px solid #86efac;padding:18px 22px;border-radius:20px;box-shadow:0 4px 14px -6px rgba(16,185,129,.25);margin:0 0 20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-size:15px;font-weight:700;color:#064e3b;">Question 5: Given the current alert snapshot above, which single alert would you triage first and why?</div>
            <button class="save-progress-btn" data-question="5" style="background:#10b981;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;">Save Progress</button>
          </div>
          <div id="triageAnswer" style="border:1px solid #cbd5e1;border-radius:14px;background:#fff;min-height:200px;"></div>
        </div>
        <div style="background:#dcfce7;border:1px solid #86efac;padding:18px 22px;border-radius:20px;box-shadow:0 4px 14px -6px rgba(16,185,129,.25);margin:26px 0 20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-size:15px;font-weight:700;color:#064e3b;">Question 6: Describe the selected alert and its impact on the tenant's environment.</div>
            <button class="save-progress-btn" data-question="6" style="background:#10b981;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;">Save Progress</button>
          </div>
          <div id="alertDescriptionAnswer" style="border:1px solid #cbd5e1;border-radius:14px;background:#fff;min-height:200px;"></div>
        </div>
        
        <!-- Tenant ID Verification Section -->
        <div style="background:#fef3c7;border:1px solid #fbbf24;padding:18px 22px;border-radius:20px;box-shadow:0 4px 14px -6px rgba(251,191,36,.25);margin:26px 0 20px;">
          <div style="font-size:15px;font-weight:700;color:#92400e;margin-bottom:12px;">Enter Tenant ID to Continue</div>
          <div style="font-size:13px;color:#78350f;margin-bottom:12px;">Enter the tenant ID from the alert details to access the portal and continue the investigation.</div>
          <div style="display:flex;gap:10px;align-items:center;">
            <input type="text" id="tenantIdInput" placeholder="Enter Tenant ID from alert details" style="flex:1;padding:10px 14px;border:1px solid #fbbf24;border-radius:10px;font-size:13px;font-family:ui-monospace,monospace;" />
            <button id="verifyTenantBtn" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border:none;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;">Verify & Access Portal</button>
          </div>
          <div id="tenantVerifyMsg" style="margin-top:10px;font-size:12px;min-height:18px;"></div>
        </div>
      </div>
    </div>
    
    <!-- Infinity Portal Panel -->
    <div class="panel" id="panel-portal" data-panel="portal" style="display:none;">
      <h2>Infinity Portal - Gateway Management</h2>
      <p class="small-hint">Access gateway terminals and execute remediation tasks.</p>
      
      <div id="portalAndQuestionsSection">
          <!-- Portal with All Gateways Section -->
          <div style="background:#e0f2fe;border:1px solid #0ea5e9;padding:18px 22px;border-radius:20px;box-shadow:0 4px 14px -6px rgba(14,165,233,.25);margin:26px 0 20px;">
            <div style="font-size:15px;font-weight:700;color:#075985;margin-bottom:12px;">Infinity Portal - Gateway Access</div>
            <div style="font-size:13px;color:#0c4a6e;margin-bottom:12px;">Click on any gateway name to open its SSH terminal below.</div>
            <iframe id="portalIframe" src="/infinity-portal-mock.html" title="Infinity Portal Mock" style="width:100%;height:320px;border:1px solid #7dd3fc;border-radius:14px;background:#fff;box-shadow:0 2px 8px -2px rgba(14,165,233,.2);"></iframe>
            
            <!-- Gateway Terminal Section (appears when gateway is clicked) -->
            <div id="gatewayTerminalSectionMain" style="display:none;margin-top:16px;border:1px solid #7dd3fc;border-radius:14px;background:#f0f9ff;padding:16px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h4 id="gatewayTerminalTitle" style="margin:0;font-size:14px;color:#075985;">Gateway Terminal: <span id="gatewayNameDisplay"></span></h4>
                <button id="downloadTerminalBtn" style="background:#10b981;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">Download Terminal Log</button>
              </div>
              <div id="gatewayTerminal" style="background:#000;border-radius:8px;padding:0;height:420px;overflow:hidden;"></div>
            </div>
          </div>
          
          <div style="background:#dcfce7;border:1px solid #86efac;padding:18px 22px;border-radius:20px;box-shadow:0 4px 14px -6px rgba(16,185,129,.25);margin:26px 0 20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <div style="font-size:15px;font-weight:700;color:#064e3b;">Question 7: Compare the affected gateway vs. a healthy gateway</div>
              <button class="save-progress-btn" data-question="7" style="background:#10b981;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;">Save Progress</button>
            </div>
            <div style="margin-top:10px;font-size:13px;color:#065f46;margin-bottom:12px;">Provide two screenshots (affected vs healthy) and a brief description of the differences.</div>
            <div id="gatewayComparisonAnswer" style="border:1px solid #cbd5e1;border-radius:14px;background:#fff;min-height:200px;"></div>
          </div>
          <div style="background:#dcfce7;border:1px solid #86efac;padding:18px 22px;border-radius:20px;box-shadow:0 4px 14px -6px rgba(16,185,129,.25);margin:26px 0 20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <div style="font-size:15px;font-weight:700;color:#064e3b;">Question 8: Follow the playbook step by step and document each stage.</div>
              <button class="save-progress-btn" data-question="8" style="background:#10b981;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;">Save Progress</button>
            </div>
            <div style="margin-top:10px;font-size:13px;color:#065f46;margin-bottom:12px;">Execute the investigation/cleanup part of the playbook exactly in order and document:<br>Provide screenshots for each step and a final summary screenshot of the final disk state.</div>
            <div id="playbookExecutionAnswer" style="border:1px solid #cbd5e1;border-radius:14px;background:#fff;min-height:200px;"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <div class="actions" style="justify-content:flex-start;">
    
  </div>
</main>
<script src="/header-timer.js" defer></script>
<script>
(function(){
  const KEY='alertCorrelationTask_v1';
    const VERSION=19; // v19 removes Tenants List panel (moved to Task 6)
  // Structured decoy playbook overrides (non-P1). Used for rich rendering instead of raw list lines.
  const PLAYBOOK_OVERRIDES={
    'ALRT-IDA-20250918-202502':{
      more:'Say EU-West update feed unstable; cache stale >24h; quick temp fixes likely.',
      cmds:[
        'ssh admin@rv-gw-03',
        'sudo rm -rf /opt/ida/cache/*',
        'sudo systemctl restart ida-updater ida-agent',
        'curl -I http://updates.ida.example.com/health',
        'sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT'
      ],
      decision:'If df -h shows space and curl returns 200 → Resolved; else escalate to IDA Feed Ops.'
    },
    'ALRT-CPU-20250918-191219':{
      more:'Host gw-core-12 pinned at 95%+, likely undersized VM.',
      cmds:[
        'ssh admin@gw-core-12',
        "lscpu && grep -E 'cpu|throttle' /proc/*/status 2>/dev/null | head",
        'docker stats --no-stream',
        'sudo systemctl set-property --runtime -- user.slice CPUQuota=0',
        '# plan resize:',
        'echo "request vCPU=8 mem=16G" | tee /tmp/scale.txt'
      ],
      decision:'If sustained user CPU > 90% for 10m after removing quotas AND latency rising → escalate to Compute Capacity; else Resolved.'
    },
    'ALRT-RV-20250918-184950-A':{
      more:'Licensing ceiling exceeded; user surge from Osaka.',
      cmds:[
        'ssh admin@rv-edge-osaka',
        "grep -n 'max-clients' /etc/openvpn/server.conf",
        "sudo sed -i 's/^max-clients.*/max-clients 2000/' /etc/openvpn/server.conf",
        'sudo systemctl restart openvpn-server'
      ],
      decision:'If active users > 1500 persist 10m → add second RV node; else Resolved.'
    },
    'ALRT-RV-20250918-184950-B':{
      more:'Licensing ceiling exceeded; user surge from Osaka. (Duplicate row)',
      cmds:[
        'ssh admin@rv-edge-osaka',
        "grep -n 'max-clients' /etc/openvpn/server.conf",
        "sudo sed -i 's/^max-clients.*/max-clients 2000/' /etc/openvpn/server.conf",
        'sudo systemctl restart openvpn-server'
      ],
      decision:'Duplicate of -A; follow same decision path.'
    },
    'ALRT-IDN-20250918-185004':{
      more:'Transient network latency; client timeouts too short.',
      cmds:[
        'ssh app@idn-eu-web01',
        'sudo sed -i "s/^http_timeout=.*/http_timeout=120/" /etc/idn/app.conf',
        'sudo systemctl restart idn-api',
        'curl -m 120 -sS https://idp.eu.example.com/health'
      ],
      decision:'If health checks 200 for 10m and timeout errors < 5/min → Resolved; else escalate to IDN Platform.'
    },
    'ALRT-LAAS-20250918-195319':{
      more:'API key mismatch suspected.',
      cmds:[
        'export NEW_KEY=AKIA...REDACTED',
        'sudo sed -i "s/API_KEY=.*/API_KEY=${NEW_KEY}/" /etc/exporter/env',
        'sudo systemctl restart laas-exporter',
        'curl -v https://laas.example.com/ping'
      ],
      decision:'If signed URL requests succeed (2xx) & error rate < 1% for 5m → Resolved; else escalate to LaaS Auth.'
    },
    'ALRT-LAAS-20250918-170319':{
      more:'Older exporters still using legacy token.',
      cmds:[
        "ansible all -m shell -a 'systemctl restart laas-exporter && rm -f /etc/exporter/tokens.d/old-*'"
      ],
      decision:'If all exporters report new token and failures drop → Resolved; else escalate to LaaS Deploy.'
    },
    'ALRT-LAAS-20250918-201319':{
      more:'Region gateway blocks by reputation; whitelist IPs.',
      cmds:[
        'curl -vk https://uae.laas.example.com/ingest',
        '# file a whitelist request with outbound IP: $(curl -s ifconfig.me)'
      ],
      decision:'If ingestion 2xx after whitelist or alternative path → Resolved; else escalate to LaaS Network.'
    },
    'ALRT-DSS-20250918-105918':{
      more:'Kafka saturation suspected; backlog growth.',
      cmds:[
        '/opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --alter --topic dss-events --partitions 10',
        '/opt/kafka/bin/kafka-configs.sh --bootstrap-server kafka:9092 --alter --entity-type topics --entity-name dss-events --add-config retention.ms=1209600000'
      ],
      decision:'If backlog drains & consumer lag < threshold for 15m → Resolved; else escalate to Streaming Platform.'
    }
  };
  // Fallback static alerts reduced to requested P1 + new P3 LaaS alert
  const ALERTS_FALLBACK=[
    {"id":"ALRT-MEM-20250917-053802","product":"Harmony Connect","severity":"P1","title":"[FIRING:1] Instance | High Disk Usage - var log","customer":"disk usage var log alertinfoTM-92250","time_iso":"2025-09-17T05:38:00+03:00","affectedGateway":"g4","tenantId":"8ab93415-5bb1-4fdf-b1dc-2d1174626109"},
    {"id":"ALRT-LAAS-20250205-EXPNOTENABLED","product":"LaaS","severity":"P3","title":"Main LaaS Sanity | Exporter is not enabled {}","customer":"Main LaaS Sanity","time_iso":"2025-02-05T09:00:00Z","createdBy":"Benjamin Sabbag","lastModified":"2025-02-05","moreInfoHref":"#kb/KB-LAAS-EXPNOTENABLED","playbookId":"PB-LAAS-EXPORTER-NOT-ENABLED","tenantId":"7c2f8a93-1e4b-4a8c-9d5e-3f6b2c1a8e7d"},
    {"id":"ALRT-MON-20250203-DELAY","product":"Monitoring","severity":"P4","title":"Metric Collection Delay Detected","customer":"Global Retail Systems","time_iso":"2025-02-03T14:22:00Z","tenantId":"9f3e5c71-4d2a-4b9f-8e6d-1a7c3b5f4e2a"},
    {"id":"ALRT-API-20250203-SLOWRESP","product":"API Gateway","severity":"P4","title":"API Response Time Elevated","customer":"FinTech Solutions","time_iso":"2025-02-03T13:15:00Z","tenantId":"2d4e8b19-6f3c-4e7a-9b2d-5c8f1a4e6b3d"},
    {"id":"ALRT-CERT-20250203-EXPIRING","product":"Certificate Manager","severity":"P5","title":"SSL Certificate Expiring in 45 Days","customer":"Healthcare Networks","time_iso":"2025-02-03T10:30:00Z","tenantId":"5a7c3f82-9e1b-4d6c-8f4a-2b9e5c7d1f3a"},
    {"id":"ALRT-LOG-20250203-ROTATION","product":"Log Management","severity":"P5","title":"Log Rotation Warning","customer":"Manufacturing Corp","time_iso":"2025-02-03T09:45:00Z","tenantId":"4e9b2c71-8d3f-4a6e-9c2b-7f5a1d8e4c6b"},
    {"id":"ALRT-BACKUP-20250203-SLOW","product":"Backup Service","severity":"P4","title":"Backup Duration Exceeded Threshold","customer":"Media Distribution","time_iso":"2025-02-03T08:00:00Z","tenantId":"6c1f4e93-2a8d-4b7e-9f3c-5d8a2e6f1b4c"},
    {"id":"ALRT-DNS-20250203-LATENCY","product":"DNS Service","severity":"P5","title":"DNS Query Latency Spike","customer":"Education Platform","time_iso":"2025-02-03T07:20:00Z","tenantId":"8d2e6f41-9c3b-4a7d-8e5f-2c9a4b1d7e3f"},
    {"id":"ALRT-CACHE-20250203-HITRATE","product":"Cache Layer","severity":"P4","title":"Cache Hit Rate Below Target","customer":"E-Commerce Hub","time_iso":"2025-02-03T06:10:00Z","tenantId":"3f7a9e52-4b8c-4d1e-9a6f-5e2c8d4f1b7a"},
    {"id":"ALRT-LB-20250203-UNEVEN","product":"Load Balancer","severity":"P5","title":"Uneven Traffic Distribution","customer":"Gaming Platform","time_iso":"2025-02-03T05:30:00Z","tenantId":"1b4e8c93-7f2d-4a9e-8c5b-6d3f9a2e4c1b"}
  ];
  function useFallback(){
    if(alerts.length>0) return; // don't overwrite if already loaded
    alerts=ALERTS_FALLBACK.map(a=>({
      id:a.id,
      team:'Harmony Sase',
      priority:a.severity,
      title:a.title,
      context:a.customer,
      opened:new Date(a.time_iso).toLocaleString(),
      raw:a
    }));
    // Inject tenant/account details for P1 alert
    alerts.forEach(a=>{ if(a.id==='ALRT-MEM-20250917-053802'){ a.raw.tenant_id='8ab93415-5bb1-4fdf-b1dc-2d1174626109'; a.raw.account_name='CloudSync International Corp'; a.raw.account_id='8ab93415-5bb1-4fdf-b1dc-2d1174626109'; } });
  repositionP1();
    renderAlerts();
    updateCounters();
  }
  // Elements
  const tabButtons=[...document.querySelectorAll('.tab-btn')];
  const panels=[...document.querySelectorAll('.panel')];
  function activate(tab){
    tabButtons.forEach(b=>{const on=b.dataset.tab===tab; b.classList.toggle('active',on); b.setAttribute('aria-selected',on?'true':'false');});
    panels.forEach(p=> {
      const isActive = p.dataset.panel===tab;
      p.classList.toggle('active', isActive);
      p.style.display = isActive ? 'block' : 'none';
    });
  }
  tabButtons.forEach(btn=> btn.addEventListener('click',()=>{
    const heroBox = document.querySelector('.hero-box');
    const offset = 80;
    const elementPosition = heroBox.getBoundingClientRect().top + window.pageYOffset;
    window.scrollTo({top: elementPosition - offset, behavior: 'smooth'});
    activate(btn.dataset.tab);
  }));

  // Alerts (static snapshot)
  const alertsBody=document.getElementById('alertsBody');
  const ctrTotal=document.getElementById('ctrTotal');
  const ctrP1=document.getElementById('ctrP1');
  const ctrP2P3=document.getElementById('ctrP2P3');
  const ctrLower=document.getElementById('ctrLower');
  let alerts=[]; // static objects
  // timeline removed in v5
  // (Correlation fields removed in Tenants refactor)
  // Actions
  const actActions=document.getElementById('actActions');
  const actVerif=document.getElementById('actVerif');
  const actRollback=document.getElementById('actRollback');
  // Root cause
  const rcCause=document.getElementById('rcCause');
  const rcImpact=document.getElementById('rcImpact');
  const rcRisk=document.getElementById('rcRisk');
  const rcHandover=document.getElementById('rcHandover');
  // Timeline elements removed in v5

  // Save/UI controls removed
  const priorityAnswer=document.getElementById('priorityAnswer');
  const priorityDescribe=document.getElementById('priorityDescribe');
  const q1Answer=document.getElementById('q1Answer');
  const q2Answer=document.getElementById('q2Answer');

  function markDirty(){}
  function markSaved(){}
  function renderAlerts(){
    alertsBody.innerHTML='';
    alerts.forEach(a=>{
      const tr=document.createElement('tr');
      tr.className='alert-row';
      tr.dataset.id=a.id;
      tr.innerHTML=`<td>${esc(a.team)}</td><td>${renderSeverity(a.priority)}</td><td>${esc(a.title)}</td><td>${esc(a.context||'')}</td><td style="white-space:nowrap;">${esc(a.opened)}</td><td><button type=\"button\" class=\"inline-btn\" data-more=\"${a.id}\">More Info</button></td><td><a href="#" data-id="${a.id}" class="inline-btn" data-act="playbook">Playbooks</a></td>`;
      alertsBody.appendChild(tr);
    });
    updateCounters();
  }
  function renderSeverity(sev){ return `<span class="sev-pill sev-${esc(sev)}">${esc(sev)}</span>`; }
  function updateCounters(){
    ctrTotal.textContent='TOTAL: '+alerts.length;
    ctrP1.textContent='P1: '+alerts.filter(a=>a.priority==='P1').length;
    ctrP2P3.textContent='P2/P3: '+alerts.filter(a=>a.priority==='P2'||a.priority==='P3').length;
    ctrLower.textContent='P4/P5: '+alerts.filter(a=>a.priority==='P4'||a.priority==='P5').length;
  }
  alertsBody.addEventListener('click',e=>{
    const moreBtn=e.target.closest('button.inline-btn[data-more]');
    if(moreBtn){ const id=moreBtn.getAttribute('data-more'); const a=alerts.find(x=>x.id===id); if(a) showDetail(a); return; }
    const playbookLink=e.target.closest('a.inline-btn[data-act="playbook"]');
    if(playbookLink){ e.preventDefault(); const id=playbookLink.getAttribute('data-id'); const a=alerts.find(x=>x.id===id); if(a) showPlaybookDetail(a); return; }
    const row=e.target.closest('tr.alert-row'); if(!row) return; const id=row.dataset.id; const a=alerts.find(x=>x.id===id); if(a) showDetail(a);
  });

  const detailEl=document.getElementById('alertDetail');
  let currentDetail=null;
  function hideDetail(){ detailEl.classList.remove('active'); detailEl.innerHTML=''; currentDetail=null; }
  function showDetail(a){
    currentDetail=a;
    const r=a.raw||{};
    const play=(r.playbook||[]).join('\n');
    let richSection='';
    if(r.id==='ALRT-MEM-20250917-053802'){
      // Reuse same structured layout as playbook view (summary) for consistency
      richSection=`<div style="margin-top:8px;border:1px solid #f9a8d4;border-radius:16px;padding:12px 16px;background:#fffafb;">
        <div style="font-weight:600;text-align:center;padding:4px 8px;border:1px solid #fbcfe8;background:#ffe4ef;border-radius:10px;margin-bottom:10px;">Structured Playbook Snapshot</div>
        <div style="font-size:12.5px;">Memory / disk validation & cleanup steps available via Playbooks link.</div>
      </div>`;
    } else if(PLAYBOOK_OVERRIDES[r.id]){
      const o=PLAYBOOK_OVERRIDES[r.id];
      richSection=`<div style="margin-top:8px;border:1px solid #f9a8d4;border-radius:16px;padding:12px 16px;background:#fffafb;">
        <div style="font-weight:600;text-align:center;padding:4px 8px;border:1px solid #fbcfe8;background:#ffe4ef;border-radius:10px;margin-bottom:10px;">Decoy Structured Playbook</div>
        <div style="font-size:12.5px;margin-bottom:8px;">${esc(o.more)}</div>
        <div style="font-weight:600;font-size:12px;margin:4px 0 4px;">Commands (preview)</div>
        <ul style="margin:0 0 8px 18px;padding:0;font-size:12.5px;">${o.cmds.slice(0,3).map(c=>`<li><code style=\"background:#0f172a;color:#fbcfe8;border:none;padding:2px 5px;border-radius:6px;\">${esc(c)}</code></li>`).join('')}${o.cmds.length>3?'<li>…</li>':''}</ul>
        <div style="font-size:12px;"><strong>Decision:</strong> ${esc(o.decision)}</div>
      </div>`;
    }
  const openedISO=r.time_iso||'';
  const lastUpd=r.last_updated_iso||'';
  const lastDup=r.last_duplicated_iso||'';
  const elapsed=r.elapsed_hint||'';
  const alias=r.alias||'';
  const ownerTeam=r.owner_team||'';
  const tenant=r.tenant_id||'';
  const labelsObj=r.raw_labels||null;
  const annObj=r.raw_annotations||null;
    // Playbook & examiner notes formatting
    const decoys=(r.decoy_tags||[]).join(', ');
    const trueCause=r.examiner_notes?.true_cause||'';
    let overrideMarkdown='';
    if(r.id!== 'ALRT-MEM-20250917-053802' && PLAYBOOK_OVERRIDES[r.id]){
      const o=PLAYBOOK_OVERRIDES[r.id];
      const summaryLine=`Product: ${esc(r.product)} | Priority: ${esc(r.severity)} | Alert: ${esc(r.title)} | Context: ${esc(r.customer)} | Opened: ${esc(a.opened)}`;
      const cmdBlock=o.cmds.map(c=>'  '+c).join('\n');
      overrideMarkdown=[
        summaryLine,
        '',
        '### More Info (decoy)',
        o.more,
        '',
        '### Playbook (decoy steps/commands)',
        'Commands to run:\n',
        cmdBlock,
        '',
        '### Decision',
        o.decision
      ].join('\n');
    }
    const validation=(r.examiner_notes?.validation||[]).map(v=>'* '+esc(v)).join('\n');
    const correctPb=(r.examiner_notes?.correct_playbook||[]).map(v=>'* '+esc(v)).join('\n');
    detailEl.innerHTML=`<button class="close-detail" type="button" aria-label="Close detail">✕</button>
      <div class="detail-section"><strong>Candidate Provided / Visible Playbook</strong>${richSection?'<div style=\"margin-top:8px;\">'+richSection+'</div>': (overrideMarkdown?`<pre class=\"code-block\" style=\"margin-top:6px;white-space:pre-wrap;\">${esc(overrideMarkdown)}</pre>`:`<pre class=\"code-block\" style=\"margin-top:6px;white-space:pre-wrap;\">${esc(play)||'No playbook lines defined.'}</pre>`)}</div>
      <div class="detail-meta">Opened <strong>${esc(openedISO)}</strong>${lastUpd? ' • Last Updated <strong>'+esc(lastUpd)+'</strong>':''}${elapsed? ' • Elapsed <strong>'+esc(elapsed)+'</strong>':''}${decoys? ' • Decoy Tags: <strong>'+esc(decoys)+'</strong>':''}</div>
      <div class="kv-grid">
        ${kv('Product', r.product)}
        ${kv('Customer', r.customer)}
        ${kv('Status', r.status)}
        ${kv('Severity', r.severity)}
        ${kv('Alert ID', r.id)}
        ${alias?kv('Alias', alias):''}
        ${ownerTeam?kv('Owner Team', ownerTeam):''}
        ${tenant?kv('Tenant', tenant):''}
        ${r.affectedGateway?kv('Affected Gateway', r.affectedGateway):''}
        ${r.account_name?kv('Account', r.account_name):''}
        ${r.account_id?kv('Account Id', r.account_id):''}
        ${lastDup?kv('Last Duplicated', lastDup):''}
      </div>
      ${labelsObj?`<div class="detail-section"><strong>Raw Labels</strong><pre class="code-block" style="margin-top:6px;white-space:pre-wrap;">${esc(Object.entries(labelsObj).map(([k,v])=>k+' = '+v).join('\n'))}</pre></div>`:''}
      ${annObj?`<div class="detail-section"><strong>Annotations</strong><pre class="code-block" style="margin-top:6px;white-space:pre-wrap;">${esc(Object.entries(annObj).map(([k,v])=>k+' = '+v).join('\n'))}</pre></div>`:''}
      ${trueCause?`<div class="detail-section"><strong>Examiner True Cause</strong><pre class="code-block" style="margin-top:6px;white-space:pre-wrap;">${esc(trueCause)}</pre></div>`:''}
      ${validation?`<div class="detail-section"><strong>Validation Signals</strong><pre class="code-block" style="margin-top:6px;white-space:pre-wrap;">${validation}</pre></div>`:''}
      ${correctPb?`<div class="detail-section"><strong>Correct Engineering Playbook</strong><pre class="code-block" style="margin-top:6px;white-space:pre-wrap;">${correctPb}</pre></div>`:''}
    `;
    detailEl.querySelector('.close-detail').addEventListener('click',hideDetail);
    detailEl.classList.add('active');
    detailEl.scrollIntoView({behavior:'smooth',block:'center'});
  }

  function showPlaybookDetail(a){
    currentDetail=a;
    const r=a.raw||{};
    const play=(r.playbook||[]).map((l,i)=> (i+1)+'. '+l).join('\n');
    const correct=(r.examiner_notes?.correct_playbook||[]).map((l,i)=> (i+1)+'. '+l).join('\n');
    const tips=[
      'Assess whether provided steps waste time / cause risk before executing.',
      'Always validate symptom vs cause (e.g., agent vs real CPU saturation).',
      'Consolidate duplicates before mass actions to reduce noise.'
    ].map(t=>'• '+t).join('\n');
    // Rich formatted playbook override for specific P1 (disk full / cleanup) embedding Confluence-style layout
    let richSection='';
    if(r.id==='ALRT-MEM-20250917-053802'){
      richSection=`<div class="detail-section" style="margin-top:22px;">
        <strong style="font-size:14px;">Structured Playbook (Memory / Space Validation & Cleanup)</strong>
        <div style="margin-top:10px;border:1px solid #f9a8d4;border-radius:16px;padding:14px 18px;background:#fffafb;">
          <div style="font-weight:600;text-align:center;padding:6px 10px;border:1px solid #fbcfe8;background:#ffe4ef;border-radius:10px;margin-bottom:16px;">Preliminary</div>
          <div style="font-size:12.5px;margin-bottom:18px;">
            <ol style="margin:0 0 0 18px;padding:0;">
              <li>Go to <a href="#" onclick="document.querySelector('.tab-btn[data-tab=tenants]').click(); return false;" style="color:#db2777;font-weight:600;text-decoration:none;border-bottom:1px solid #fbcfe8;">Tenant List</a> (click to open tenant finder tab)</li>
              <li>Search for your tenant by <strong>Tenant ID</strong> from Additional Info</li>
              <li>After finding it, click on the tenant - this will take you to our portal where you can run commands from this playbook</li>
              <li>Find the affected gateway and click on it to SSH connect to it</li>
            </ol>
          </div>
          <div style="font-weight:600;text-align:center;padding:6px 10px;border:1px solid #fbcfe8;background:#fff5cc;border-radius:10px;margin:4px 0 16px;">Investigation / Cleanup</div>
          <div style="display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
            <div style="border:1px solid #fbcfe8;background:#fff;border-radius:12px;padding:12px 14px;">
              <div style="font-weight:600;font-size:12.5px;margin:0 0 8px;">/var/log/</div>
              <ol style="margin:0 0 10px 18px;padding:0;font-size:12.5px;">
                <li>Check size of <code>/var/log/crash</code></li>
                <li>Remove old crash dumps if present</li>
                <li>If new crash dumps:
                  <ol type="a" style="margin:6px 0 8px 18px;">
                    <li>SFTP copy crash files off host</li>
                    <li>Remove the files</li>
                    <li>Proceed to <strong>Not Resolved</strong></li>
                  </ol>
                </li>
              </ol>
              <div style="font-size:12px;margin-top:4px;">Run <code style="background:#0f172a;color:#fbcfe8;border:none;padding:2px 6px;border-radius:6px;">df -h</code> again</div>
              <ol type="a" style="margin:6px 0 0 18px;font-size:12.5px;">
                <li>If enough free storage → <strong>Resolved</strong></li>
                <li>Still full → <strong>Not Resolved</strong></li>
              </ol>
            </div>
            <div style="border:1px solid #fbcfe8;background:#fff;border-radius:12px;padding:12px 14px;">
              <div style="font-weight:600;font-size:12.5px;margin:0 0 8px;">$DLPDIR/ftp:</div>
              <ol style="margin:0 0 8px 18px;padding:0;font-size:12.5px;">
                <li>Remove bulk folders:
                  <ol type="a" style="margin:6px 0 0 18px;">
                    <li><code>rm -r $DLPDIR/ftp/0*</code></li>
                    <li><code>rm -r $DLPDIR/ftp/1*</code></li>
                    <li><code>rm -r $DLPDIR/ftp/3*</code></li>
                  </ol>
                </li>
              </ol>
            </div>
          </div>
          <div style="font-weight:700;text-align:center;margin:22px 0 10px;padding:8px 12px;border-radius:10px;background:#dc2626;color:#fff;">Not Resolved</div>
          <div style="border:1px solid #fbcfe8;border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:12.5px;">Assign TM (escalate underlying producer / leak)</div>
          <div style="font-weight:700;text-align:center;padding:8px 12px;border-radius:10px;background:#10b981;color:#053321;">Resolved</div>
        </div>
      </div>`;
    }
    // For all non-P1 alerts, render structured decoy card if override present
    if(r.id!=='ALRT-MEM-20250917-053802' && PLAYBOOK_OVERRIDES[r.id]){
      const o=PLAYBOOK_OVERRIDES[r.id];
      richSection=`<div style="margin-top:12px;border:1px solid #f9a8d4;border-radius:16px;padding:14px 18px;background:#fffafb;">
        <div style="font-weight:600;text-align:center;padding:6px 10px;border:1px solid #fbcfe8;background:#ffe4ef;border-radius:10px;margin-bottom:12px;">Decoy Structured Playbook</div>
        <div style="font-size:12.5px;line-height:1.5;margin-bottom:14px;">${esc(o.more)}</div>
        <div style="font-weight:600;font-size:12px;margin:0 0 6px;">Commands</div>
        <ul style="margin:0 0 10px 18px;padding:0;font-size:12.5px;">${o.cmds.map(c=>`<li><code style=\"background:#0f172a;color:#fbcfe8;border:none;padding:2px 5px;border-radius:6px;\">${esc(c)}</code></li>`).join('')}</ul>
        <div style="font-weight:600;font-size:12px;margin:6px 0 6px;">Decision</div>
        <div style="font-size:12.5px;">${esc(o.decision)}</div>
      </div>`;
    }
    detailEl.innerHTML=`<button class="close-detail" type="button" aria-label="Close detail">✕</button>
      <h3>Playbook — ${esc(a.title)} ${renderSeverity(a.priority)}</h3>
      <div class="detail-meta">Alert ID <strong>${esc(r.id||'')}</strong> • Severity <strong>${esc(r.severity||'')}</strong></div>
      <div class="detail-section"><strong>Candidate Provided / Visible Playbook</strong>${richSection?'<div style=\"margin-top:8px;\">'+richSection+'</div>':`<pre class="code-block" style="margin-top:6px;white-space:pre-wrap;">${esc(play)||'No playbook lines defined.'}</pre>`}</div>
      ${correct ? `<div class="detail-section"><strong>Examiner Correct Engineering Playbook</strong><pre class="code-block" style="margin-top:6px;white-space:pre-wrap;">${correct}</pre></div>`:''}
      <div class="detail-section"><strong>Guidance Tips</strong><pre class="code-block" style="margin-top:6px;white-space:pre-wrap;">${tips}</pre></div>
    `;
    detailEl.querySelector('.close-detail').addEventListener('click',hideDetail);
    detailEl.classList.add('active');
    detailEl.scrollIntoView({behavior:'smooth',block:'center'});
  }
  function kv(k,v){ return `<div class="kv-item"><span class="key">${esc(k)}</span><span class="val">${esc(v||'')}</span></div>`; }
  function formatKVList(o){ if(!o) return ''; return Object.entries(o).map(([k,v])=>`${k} = ${v}`).join('\n'); }
  function calcElapsed(startIso,endIso){ try{ const s=new Date(startIso).getTime(); const e=new Date(endIso).getTime(); let d=Math.max(0,e-s); const days=Math.floor(d/86400000); d%=86400000; const h=Math.floor(d/3600000); d%=3600000; const m=Math.floor(d/60000); return `${days}d ${h}h ${m}m`; }catch{return '?';} }

  // Timeline functions removed in v5

  function save(){}
  function load(){
    try {
      const raw=localStorage.getItem(KEY);
      if(raw){
        const data=JSON.parse(raw);
        if(data){
          // timeline removed in v5
          if(data.actions){ actActions.value=data.actions.actions||''; actVerif.value=data.actions.verification||''; actRollback.value=data.actions.rollback||''; }
          if(data.root){ rcCause.value=data.root.cause||''; rcImpact.value=data.root.impact||''; rcRisk.value=data.root.risk||''; rcHandover.value=data.root.handover||''; }
          if(typeof data.priorityAnswer==='string'){ priorityAnswer.value=data.priorityAnswer; }
          if(typeof data.priorityDescribe==='string'){ priorityDescribe.value=data.priorityDescribe; }
          if(typeof data.q1==='string'){ q1Answer.value=data.q1; }
          if(typeof data.q2==='string'){ q2Answer.value=data.q2; }
        }
      }
    } catch(e){
      console.warn('Load fail',e);
    }
    defineStaticAlerts(); // async will render when done
    // renderTimeline removed in v5
    markSaved();
  }
  function clearAll(){}

  function exportJSON(){}

  function esc(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function fmtTime(iso){ try{ const d=new Date(iso); return d.toISOString().replace('T',' ').slice(0,19)+'Z'; }catch{return iso; } }

  // Timeline event listener removed in v5

  // dirty tracking for text areas
  [actActions,actVerif,actRollback,rcCause,rcImpact,rcRisk,rcHandover,q1Answer,q2Answer].forEach(el=> el && el.addEventListener('input',markDirty));

  load();
  async function defineStaticAlerts(){
    try{
      const res=await fetch('mock_alerts.json',{cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json();
      alerts=(data.alerts||[]).map(a=>({
        id:a.id,
        team:'Harmony Sase',
        priority:a.severity,
        title:a.title,
        context:a.customer,
        opened:new Date(a.time_iso).toLocaleString(),
        raw:a
      }));
      // Inject tenant/account details for P1 alert
      alerts.forEach(a=>{ if(a.id==='ALRT-MEM-20250917-053802'){ a.raw.tenant_id='8ab93415-5bb1-4fdf-b1dc-2d1174626109'; a.raw.account_name='CloudSync International Corp'; a.raw.account_id='8ab93415-5bb1-4fdf-b1dc-2d1174626109'; } });
      // If P3 exporter-not-enabled alert missing, append it
      if(!alerts.find(x=>x.id==='ALRT-LAAS-20250205-EXPNOTENABLED')){
        alerts.push({
          id:'ALRT-LAAS-20250205-EXPNOTENABLED',
          team:'Harmony Sase',
          priority:'P3',
          title:'Main LaaS Sanity | Exporter is not enabled {}',
          context:'Main LaaS Sanity',
          opened:new Date('2025-02-05T09:00:00Z').toLocaleString(),
          raw:{id:'ALRT-LAAS-20250205-EXPNOTENABLED',product:'LaaS',severity:'P3',title:'Main LaaS Sanity | Exporter is not enabled {}',customer:'Main LaaS Sanity',time_iso:'2025-02-05T09:00:00Z',createdBy:'Benjamin Sabbag',lastModified:'2025-02-05',moreInfoHref:'#kb/KB-LAAS-EXPNOTENABLED',playbookId:'PB-LAAS-EXPORTER-NOT-ENABLED'}
        });
      }
      // Don't filter - keep all alerts including P4/P5
      repositionP1();
      renderAlerts();
      updateCounters();
      if(alerts.length===0) useFallback();
    }catch(e){
      console.warn('Failed to load mock_alerts.json',e);
      useFallback();
    }
  }
  // Move P1 alert (if present) to a random non-last position for variability
  function repositionP1(){
    const idx=alerts.findIndex(a=>a.priority==='P1');
    if(idx===-1) return;
    const alert=alerts.splice(idx,1)[0];
    if(alert){
      let target=Math.floor(Math.random()*(alerts.length));
      // Ensure not last position to satisfy requirement
      if(target === alerts.length) target = alerts.length-1;
      if(target < 0) target = 0;
      alerts.splice(target,0,alert);
    }
  }
  // Tenants table moved to Task 6 (/task/tenants.html)
  
  // Reset gateway function - recreates disk issue in g4
  window.resetGateway = async function() {
    if (!confirm('This will reset the g4 gateway to its original state with the disk issue. Continue?')) {
      return;
    }
    
    try {
      const response = await fetch('/api/reset-gateway', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (response.ok) {
        alert('Reset done');
        // Reload terminal if it's open
        const frame = document.getElementById('gatewayTerminalFrame');
        if (frame && frame.src) {
          frame.src = frame.src; // Reload iframe
        }
      } else {
        alert('Failed to reset gateway. Please try again.');
      }
    } catch (error) {
      console.error('Reset error:', error);
      alert('Error resetting gateway: ' + error.message);
    }
  };
  
  // Tenant ID verification
  let currentTerminal = null;
  let terminalBuffer = ''; // Store all terminal output
  const validTenantId = '8ab93415-5bb1-4fdf-b1dc-2d1174626109';
  
  document.getElementById('verifyTenantBtn').addEventListener('click', function() {
    const input = document.getElementById('tenantIdInput');
    const msg = document.getElementById('tenantVerifyMsg');
    const enteredId = input.value.trim();
    
    if (!enteredId) {
      msg.style.color = '#dc2626';
      msg.textContent = '❌ Please enter a tenant ID';
      return;
    }
    
    if (enteredId === validTenantId) {
      msg.style.color = '#059669';
      msg.textContent = '✅ Tenant ID verified! Switching to Infinity Portal...';
      
      // Switch to portal tab after 1 second
      setTimeout(() => {
        activate('portal');
      }, 1000);
    } else {
      msg.style.color = '#dc2626';
      msg.textContent = '❌ Invalid tenant ID. Please check the alert details and try again.';
    }
  });
  
  // Gateway terminal function for main portal section
  window.openGatewayTerminal = function(gatewayName) {
    const mainSection = document.getElementById('gatewayTerminalSectionMain');
    if (mainSection) {
      const nameDisplay = document.getElementById('gatewayNameDisplay');
      const terminalDiv = document.getElementById('gatewayTerminal');
      
      if (nameDisplay && terminalDiv) {
        nameDisplay.textContent = gatewayName;
        
        // Clean up existing terminal
        if (currentTerminal) {
          currentTerminal.dispose();
          currentTerminal = null;
          terminalBuffer = ''; // Clear buffer when switching terminals
        }
        terminalDiv.innerHTML = '';
        
        // Check if Terminal libraries are loaded
        if (typeof Terminal === 'undefined' || typeof FitAddon === 'undefined') {
          console.error('Terminal or FitAddon not loaded');
          terminalDiv.innerHTML = '<div style="color:#fff;padding:20px;font-family:monospace;">Terminal libraries not loaded. Please refresh the page.</div>';
          mainSection.style.display = 'block';
          return;
        }
        
        // Create new xterm terminal
        const containerName = gatewayName;
        const term = new Terminal({
          cursorBlink: true,
          fontSize: 13,
          fontFamily: 'Menlo, Monaco, "Courier New", monospace',
          theme: {
            background: '#000000',
            foreground: '#ffffff'
          }
        });
        
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(terminalDiv);
        fitAddon.fit();
        
        // WebSocket connection
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${location.host}/api/terminal-ws/${containerName}`);
        
        ws.onopen = () => {
          term.write('\\r\\n\\x1b[32mConnected to ' + gatewayName + '\\x1b[0m\\r\\n\\r\\n');
          terminalBuffer += 'Connected to ' + gatewayName + '\n\n';
          
          // Send clear command when terminal opens
          setTimeout(() => {
            if (ws.readyState === WebSocket.OPEN) {
              ws.send('clear\r');
            }
          }, 500);
        };
        
        ws.onmessage = (event) => {
          term.write(event.data);
          // Store output in buffer (strip ANSI codes for clean log)
          terminalBuffer += event.data.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '');
        };
        
        term.onData((data) => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(data);
          }
        });
        
        ws.onclose = () => {
          term.write('\\r\\n\\x1b[31mConnection closed\\x1b[0m\\r\\n');
        };
        
        ws.onerror = () => {
          term.write('\\r\\n\\x1b[31mConnection error\\x1b[0m\\r\\n');
        };
        
        currentTerminal = term;
        mainSection.style.display = 'block';
        
        // Add download button handler
        const downloadBtn = document.getElementById('downloadTerminalBtn');
        if (downloadBtn) {
          downloadBtn.onclick = function() {
            const blob = new Blob([terminalBuffer], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = gatewayName + '_terminal_log_' + new Date().toISOString().replace(/[:.]/g, '-') + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          };
        }
        
        setTimeout(() => {
          mainSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
    }
  };
  
  // Initialize CKEditor for triage answer
  const { ClassicEditor, Essentials, Bold, Italic, Underline, Paragraph, List, Link, Heading, Image, ImageUpload, Base64UploadAdapter, BlockQuote, Table, MediaEmbed, CodeBlock, Code } = window.CKEDITOR;
  
  ClassicEditor.create(document.querySelector('#triageAnswer'), {
    plugins: [
      Essentials, Paragraph, Bold, Italic, Underline, Link, List, 
      Image, ImageUpload, Base64UploadAdapter, Heading, BlockQuote, Table, MediaEmbed, CodeBlock, Code
    ],
    toolbar: [
      'heading', '|',
      'bold', 'italic', 'underline', 'code', '|',
      'link', 'bulletedList', 'numberedList', '|',
      'imageUpload', 'blockQuote', 'codeBlock', 'insertTable', '|',
      'undo', 'redo'
    ],
    heading: {
      options: [
        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
      ]
    },
    image: {
      toolbar: ['imageTextAlternative']
    },
    codeBlock: {
      languages: [
        { language: 'plaintext', label: 'Plain text' },
        { language: 'bash', label: 'Bash' },
        { language: 'python', label: 'Python' },
        { language: 'json', label: 'JSON' }
      ]
    },
    placeholder: 'Type your answer here... Explain which alert you would prioritize and your reasoning.'
  }).then(editor => {
    window.editor_triageAnswer = editor;
    console.log('✓ Editor triageAnswer ready');
  }).catch(error => console.error('CKEditor initialization error:', error));
  
  // Initialize CKEditor for alert description answer
  ClassicEditor.create(document.querySelector('#alertDescriptionAnswer'), {
    plugins: [
      Essentials, Paragraph, Bold, Italic, Underline, Link, List, 
      Image, ImageUpload, Base64UploadAdapter, Heading, BlockQuote, Table, MediaEmbed, CodeBlock, Code
    ],
    toolbar: [
      'heading', '|',
      'bold', 'italic', 'underline', 'code', '|',
      'link', 'bulletedList', 'numberedList', '|',
      'imageUpload', 'blockQuote', 'codeBlock', 'insertTable', '|',
      'undo', 'redo'
    ],
    heading: {
      options: [
        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
      ]
    },
    image: {
      toolbar: ['imageTextAlternative']
    },
    codeBlock: {
      languages: [
        { language: 'plaintext', label: 'Plain text' },
        { language: 'bash', label: 'Bash' },
        { language: 'python', label: 'Python' },
        { language: 'json', label: 'JSON' }
      ]
    },
    placeholder: 'Describe the selected alert and its impact on the tenant environment...'
  }).then(editor => {
    window.editor_alertDescriptionAnswer = editor;
    console.log('✓ Editor alertDescriptionAnswer ready');
  }).catch(error => console.error('CKEditor initialization error:', error));
  
  // Initialize CKEditor for gateway comparison answer
  ClassicEditor.create(document.querySelector('#gatewayComparisonAnswer'), {
    plugins: [
      Essentials, Paragraph, Bold, Italic, Underline, Link, List, 
      Image, ImageUpload, Base64UploadAdapter, Heading, BlockQuote, Table, MediaEmbed, CodeBlock, Code
    ],
    toolbar: [
      'heading', '|',
      'bold', 'italic', 'underline', 'code', '|',
      'link', 'bulletedList', 'numberedList', '|',
      'imageUpload', 'blockQuote', 'codeBlock', 'insertTable', '|',
      'undo', 'redo'
    ],
    heading: {
      options: [
        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
      ]
    },
    image: {
      toolbar: ['imageTextAlternative']
    },
    codeBlock: {
      languages: [
        { language: 'plaintext', label: 'Plain text' },
        { language: 'bash', label: 'Bash' },
        { language: 'python', label: 'Python' },
        { language: 'json', label: 'JSON' }
      ]
    },
    placeholder: 'Compare affected gateway vs. healthy gateway with screenshots and descriptions...'
  }).then(editor => {
    window.editor_gatewayComparisonAnswer = editor;
    console.log('✓ Editor gatewayComparisonAnswer ready');
  }).catch(error => console.error('CKEditor initialization error:', error));
  
  // Initialize CKEditor for playbook execution answer
  ClassicEditor.create(document.querySelector('#playbookExecutionAnswer'), {
    plugins: [
      Essentials, Paragraph, Bold, Italic, Underline, Link, List, 
      Image, ImageUpload, Base64UploadAdapter, Heading, BlockQuote, Table, MediaEmbed, CodeBlock, Code
    ],
    toolbar: [
      'heading', '|',
      'bold', 'italic', 'underline', 'code', '|',
      'link', 'bulletedList', 'numberedList', '|',
      'imageUpload', 'blockQuote', 'codeBlock', 'insertTable', '|',
      'undo', 'redo'
    ],
    heading: {
      options: [
        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
      ]
    },
    image: {
      toolbar: ['imageTextAlternative']
    },
    codeBlock: {
      languages: [
        { language: 'plaintext', label: 'Plain text' },
        { language: 'bash', label: 'Bash' },
        { language: 'python', label: 'Python' },
        { language: 'json', label: 'JSON' }
      ]
    },
    placeholder: 'Document each playbook step with screenshots and final disk state summary...'
  }).then(editor => {
    window.editor_playbookExecutionAnswer = editor;
    console.log('✓ Editor playbookExecutionAnswer ready');
  }).catch(error => console.error('CKEditor initialization error:', error));

  // Progress tracking
  const savedQuestions = new Set();
  
  function updateProgressBar() {
    const total = 4;
    const saved = savedQuestions.size;
    const percentage = (saved / total) * 100;
    
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressText').textContent = saved + '/' + total + ' Questions Saved';
    
    // Update task progress when completed
    if (saved === total) {
      updateMainTaskProgress('alerts', 100);
      markTaskComplete('task3');
    }
  }
  
  function updateMainTaskProgress(taskId, progressPercentage) {
    try {
      const taskProgress = JSON.parse(localStorage.getItem('taskProgress') || '{}');
      taskProgress[taskId] = progressPercentage;
      localStorage.setItem('taskProgress', JSON.stringify(taskProgress));
      console.log('Task progress updated:', taskId, progressPercentage + '%');
    } catch (e) {
      console.error('Error updating task progress:', e);
    }
  }
  
  function markTaskComplete(taskId) {
    try {
      let completedTasks = JSON.parse(localStorage.getItem('examTasksCompleted') || '[]');
      if (!completedTasks.includes(taskId)) {
        completedTasks.push(taskId);
        localStorage.setItem('examTasksCompleted', JSON.stringify(completedTasks));
        console.log('Task marked complete:', taskId);
        window.dispatchEvent(new StorageEvent('storage', {
          key: 'examTasksCompleted',
          newValue: JSON.stringify(completedTasks)
        }));
      }
    } catch (e) {
      console.error('Error marking task complete:', e);
    }
  }
  
  // Save progress button handlers
  document.querySelectorAll('.save-progress-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const questionNum = this.getAttribute('data-question');
      savedQuestions.add(questionNum);
      updateProgressBar();
      
      // Visual feedback
      this.textContent = '✓ Saved';
      this.style.background = '#059669';
      setTimeout(() => {
        this.textContent = 'Save Progress';
        this.style.background = '#10b981';
      }, 2000);
    });
  });
  
  // Load saved progress from localStorage
  const storedProgress = localStorage.getItem('alertsProgress');
  if (storedProgress) {
    try {
      const progress = JSON.parse(storedProgress);
      progress.forEach(q => savedQuestions.add(q));
      updateProgressBar();
    } catch (e) {
      console.error('Error loading progress:', e);
    }
  }
  
  // Save progress to localStorage on change
  window.addEventListener('beforeunload', function() {
    localStorage.setItem('alertsProgress', JSON.stringify([...savedQuestions]));
  });
  
  // Legacy embedded log explorer removed; Mini Kibana iframe now provides advanced analytics & quiz.
})();
</script>
<script src="/simple-autosave.js" data-task-id="alerts"></script>
<a href="/contact.html" class="help-fab" title="Questions? Reach the on-call engineer.">
  <img src="/help-contact.svg" width="38" height="38" alt="Contact">
  <span class="help-label">Questions? Contact on-call.</span>
</a>
</body>
</html>
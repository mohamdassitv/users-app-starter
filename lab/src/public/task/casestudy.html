<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Task 1 ‚Äî Branch Performance (Chat)</title><meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="/styles.css"><!-- keep global styles for header ONLY -->
<style>
/* Pink Product Theme (scoped below main wrapper) */
:root{
  --pink-600:#FF5CA8;--pink-500:#FF72B0;--pink-400:#FF8CC1;--pink-200:#FFD3EC;--pink-100:#FFF5FA;
  --ink-900:#1B1B1F;--ink-700:#2E2E33;--ink-500:#6B6B72;--ink-200:#EAEAF0;--ink-50:#FFFFFF;
  --radius:22px;--space:16px;--grad-bg:radial-gradient(circle at 35% 30%,#FFE6F2 0%,#FFD6EA 42%,#FFEFF7 100%);
  --shadow-card:0 10px 30px rgba(255,92,168,.18);
  --shadow-btn:0 6px 16px -6px rgba(255,92,168,.5),0 2px 4px rgba(0,0,0,.08);
  --trans:160ms cubic-bezier(.4,.2,.2,1);
  --font-stack: "SF Pro Display","Segoe UI Variable",Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,Roboto,Helvetica,Arial,sans-serif;
}
body{font-family:var(--font-stack);background:var(--grad-bg);min-height:100vh;margin:0;color:var(--ink-700);-webkit-font-smoothing:antialiased;}
body:before{content:"";position:fixed;inset:0;pointer-events:none;background-image:repeating-linear-gradient(45deg,rgba(255,92,168,.05)0 2px,transparent 2px 6px);mix-blend-mode:overlay;opacity:.4;}
main.pink-app{max-width:100%;margin:0;padding:28px 10px 140px;}
@media (max-width:860px){main.pink-app{padding:20px 10px 120px;}}
h1.hero{margin:32px 0 14px;font-size:clamp(2.2rem,5vw,3.4rem);line-height:1.05;letter-spacing:.02em;font-weight:800;background:linear-gradient(90deg,var(--pink-600),var(--pink-400));-webkit-background-clip:text;background-clip:text;color:transparent;position:relative;}
 p.hero-sub{margin:0 0 34px;font-size:clamp(1rem,1.3vw,1.25rem);line-height:1.5;color:var(--ink-500);max-width:800px;font-weight:500;}
 .sparkles{position:absolute;inset:0;pointer-events:none;}
 .sparkles svg{position:absolute;animation:floatSpark 12s linear infinite;}
 .sparkles svg:nth-child(2){left:160px;top:10px;animation-duration:18s;}
 .sparkles svg:nth-child(3){left:320px;top:40px;animation-duration:22s;}
@keyframes floatSpark{0%{transform:translateY(0) rotate(0deg);}50%{transform:translateY(-18px) rotate(180deg);}100%{transform:translateY(0) rotate(360deg);}}

/* Tabs & layout */
.task-shell{background:rgba(255,255,255,.65);backdrop-filter:blur(22px) saturate(1.4);-webkit-backdrop-filter:blur(22px) saturate(1.4);border:1px solid rgba(255,92,168,.25);border-radius:28px;padding:26px 30px 40px;box-shadow:var(--shadow-card);position:relative;overflow:hidden;}
.task-shell:before{content:"";position:absolute;inset:0;background:linear-gradient(140deg,rgba(255,92,168,.18),rgba(255,92,168,.05));pointer-events:none;mix-blend-mode:overlay;}
.task-head{display:flex;flex-wrap:wrap;align-items:center;gap:18px;margin:0 0 14px;}
.task-head h2{margin:0;font-size:clamp(1.4rem,2.2vw,2rem);font-weight:700;letter-spacing:.5px;color:var(--ink-900);}

.tablist{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 18px;padding:0;list-style:none;}
.tablist button{border:none;border-radius:999px;padding:10px 20px;font-size:14px;font-weight:600;cursor:pointer;background:linear-gradient(90deg,var(--pink-200),var(--pink-100));color:var(--ink-700);box-shadow:0 2px 6px rgba(0,0,0,.06);transition:var(--trans);position:relative;}
.tablist button[aria-selected="true"],.tablist button:hover{background:linear-gradient(90deg,var(--pink-600),var(--pink-400));color:#fff;box-shadow:0 6px 18px -6px rgba(255,92,168,.6);}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* Chat - Professional Style */
.chat-wrap{background:#f8f9fa;border:1px solid #d1d5db;border-radius:8px;padding:18px 0 12px;display:flex;flex-direction:column;max-height:none;min-height:auto;}
.chat-scroll{overflow:auto;padding:0 24px 12px;list-style:none;margin:0;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth;}
.msg{display:flex;gap:16px;line-height:1.6;font-size:15px;margin-bottom:12px;font-weight:400;}
.msg.left{flex-direction:row;}
.msg.right{flex-direction:row-reverse;}
.msg .avatar{width:44px;height:44px;border-radius:6px;background:#6b7280;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:600;border:1px solid #9ca3af;flex-shrink:0;}
.bubble{background:#ffffff;padding:14px 18px;border-radius:8px;min-width:200px;max-width:850px;position:relative;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,.1);} 
.right .bubble{background:#e8eaf6;border-color:#c5cae9;} 
.bubble header{font-size:13px;letter-spacing:0;text-transform:none;font-weight:600;color:#374151;display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:0 0 8px;}
.right .bubble header{color:#1a237e;}
.bubble p{margin:0;font-size:15px;line-height:1.6;font-weight:400;color:#1f2937;} 
.bubble .tag{background:#e0e7ff;color:#4338ca;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;}
.right .tag{background:#c5cae9;color:#1a237e;}
.msg.info .bubble{border-color:#c7d2fe;background:#eef2ff;}
.msg.info .tag{background:#e0e7ff;color:#4338ca;}
.msg.system .avatar{background:#f59e0b;border-color:#d97706;}
.msg.system .bubble{background:#fef3c7;border-color:#fde68a;}
.msg.system .bubble header{color:#92400e;}
/* Manager - Serious Professional */
.msg.manager .avatar{background:#dc2626;border-color:#b91c1c;color:#fff;}
.msg.manager .bubble{background:#fef2f2;border:2px solid #dc2626;box-shadow:0 2px 4px rgba(220,38,38,.15);} 
.msg.manager .bubble header{color:#991b1b;font-weight:700;font-size:13px;} 
.msg.manager .bubble p{font-size:15px;font-weight:500;color:#7f1d1d;line-height:1.6;}

/* NOC Shift Messages - Professional */
.msg.noc-header .bubble{background:#1e3a8a;color:#fff;border:1px solid #1e40af;text-align:center;font-weight:600;font-size:13px;padding:10px 20px;border-radius:6px;box-shadow:0 2px 4px rgba(30,58,138,.2);min-width:300px;}
.msg.noc-header .avatar{width:44px;height:44px;background:#1e3a8a;border-color:#1e40af;}
.msg.kenji .avatar{background:#047857;border-color:#059669;}
.msg.kenji .bubble{background:#f0fdf4;border:1px solid #86efac;box-shadow:0 1px 3px rgba(16,185,129,.1);}
.msg.kenji .bubble header{color:#065f46;}
.msg.kenji .bubble p{color:#064e3b;}
.msg.ava .avatar{background:#6b21a8;border-color:#7c3aed;}
.msg.ava .bubble{background:#faf5ff;border:1px solid #d8b4fe;box-shadow:0 1px 3px rgba(139,92,246,.1);}
.msg.ava .bubble header{color:#6b21a8;}
.msg.ava .bubble p{color:#581c87;}
.msg.maya .avatar{background:#c2410c;border-color:#ea580c;}
.msg.maya .bubble{background:#fff7ed;border:1px solid #fed7aa;box-shadow:0 1px 3px rgba(245,158,11,.1);}
.msg.maya .bubble header{color:#9a3412;}
.msg.maya .bubble p{color:#7c2d12;}
.msg.liam .avatar{background:#b91c1c;border-color:#dc2626;}
.msg.liam .bubble{background:#fef2f2;border:1px solid #fca5a5;box-shadow:0 1px 3px rgba(239,68,68,.1);}
.msg.liam .bubble header{color:#991b1b;}
.msg.liam .bubble p{color:#7f1d1d;} 

/* Buttons */
.pill-btn{border:none;border-radius:999px;padding:12px 22px;font-weight:700;font-size:14px;cursor:pointer;background:linear-gradient(90deg,var(--pink-600),var(--pink-400));color:#fff;box-shadow:var(--shadow-btn);display:inline-flex;align-items:center;gap:8px;transition:var(--trans);} 
.pill-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px -10px rgba(255,92,168,.75);} 
.ghost-btn{background:var(--pink-100);color:var(--pink-600);border:1px solid var(--pink-400);} 
.ghost-btn:hover{background:var(--pink-200);} 

/* Workspace */
.workspace-wrap{display:flex;flex-direction:column;gap:16px;}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;}
.toolbar button{background:var(--pink-200);border:1px solid var(--pink-400);color:var(--pink-600);padding:6px 10px;font-size:13px;border-radius:10px;cursor:pointer;font-weight:600;}
.toolbar button:hover{background:var(--pink-400);color:#fff;}
.rte{min-height:200px;background:#fff;border:1px solid var(--pink-200);padding:14px 16px;border-radius:16px;font-size:14px;line-height:1.5;}
.rte:focus{outline:2px solid var(--pink-400);} 
.ascii-helper{font-family:ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px dashed var(--pink-400);padding:10px 12px;border-radius:16px;white-space:pre;overflow:auto;font-size:12px;}

/* Notes */
.notes-wrap{display:flex;flex-direction:column;gap:24px;}
.checklist{list-style:none;margin:0;padding:0;display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));}
.checklist li{background:#fff;border:1px solid var(--pink-200);border-radius:14px;padding:10px 12px;font-size:12px;display:flex;gap:8px;align-items:flex-start;}
.checklist input{margin-top:4px;}
.inline-fields{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));}
.inline-field{display:flex;flex-direction:column;gap:4px;}
.inline-field label{font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--pink-600);}
.inline-field input{padding:8px 10px;border:1px solid var(--pink-200);border-radius:10px;font-size:13px;}
.inline-field input:focus{outline:2px solid var(--pink-400);} 
.inline-editor.drag-hover{outline:2px dashed #10b981; background:#ecfdf5;}
.inline-editor img{display:inline-block;vertical-align:middle;}
/* Image size variants */
.inline-editor img[data-size=small]{max-width:220px;}
.inline-editor img[data-size=medium]{max-width:420px;}
.inline-editor img[data-size=large]{max-width:100%;}
/* Floating image controls */
.img-controls{position:absolute;z-index:6000;display:flex;gap:6px;background:#0f172a;color:#fff;padding:6px 8px;border-radius:10px;font-size:11px;font-family:ui-monospace,monospace;box-shadow:0 4px 12px -4px rgba(0,0,0,.5);}
.img-controls button{all:unset;cursor:pointer;background:#1e293b;color:#fff;padding:4px 8px;border-radius:6px;font-size:11px;line-height:1;font-weight:600;display:flex;align-items:center;}
.img-controls button:hover{background:#334155;}
.img-controls button:disabled{opacity:.35;cursor:not-allowed;}
.task-complete{display:flex;align-items:center;gap:10px;margin-top:12px;font-size:14px;font-weight:600;}

/* Export */
.export-bar{display:flex;flex-wrap:wrap;gap:10px;margin-top:24px;}

/* High contrast */
.high-contrast body,body.high-contrast{--pink-400:#ff3d96;--pink-600:#c80060;--ink-500:#202026;} 
body.high-contrast .task-shell{background:#fff;border-color:#111;}
body.high-contrast .bubble{box-shadow:none;}
body.high-contrast .pill-btn{box-shadow:none;}

/* Progress bar */
.progress-bar{position:fixed;top:0;left:0;height:5px;background:linear-gradient(90deg,var(--pink-600),var(--pink-400));width:0%;transition:width .4s ease;z-index:50;}

/* CKEditor full width styling */
.ck-editor{width:100% !important;max-width:100% !important;}
.ck-editor__editable{width:100% !important;max-width:100% !important;box-sizing:border-box !important;}
.ck.ck-editor__main>.ck-editor__editable{width:100% !important;max-width:100% !important;}
.ck-content{width:100% !important;max-width:100% !important;overflow-wrap:break-word !important;word-wrap:break-word !important;}
#editor-diagram, #editor-investigation{width:100% !important;max-width:100% !important;box-sizing:border-box !important;}

/* Manager view - read-only editors, everything else clickable */
body.manager-view .ck-editor__editable {
  background-color: #f9fafb !important;
  cursor: not-allowed !important;
}
body.manager-view button,
body.manager-view .tablist button,
body.manager-view a {
  pointer-events: auto !important;
  cursor: pointer !important;
}

/* Reduced motion */
@media (prefers-reduced-motion:reduce){
  *{animation:none !important;transition:none !important;}
}
</style>
</head><body class="high-contrast">
<header class="site-header" id="siteHeader">
  <div class="brand" style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="location.href='/tasks.html'">
    <img src="/logo.svg" alt="Logo" class="logo-img">
  <span class="brand-hacker" id="brandNav">CHECK POINT</span>
  </div>
  <a href="/tasks.html" style="display:flex;align-items:center;gap:6px;padding:8px 16px;background:rgba(6,78,59,0.9);color:#86efac;text-decoration:none;border-radius:8px;font-size:14px;font-weight:600;border:1px solid #86efac;transition:all 0.3s;" onmouseover="this.style.background='#047857';this.style.color='#fff'" onmouseout="this.style.background='rgba(6,78,59,0.9)';this.style.color='#86efac'">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    Main Tasks
  </a>
</header>
<!-- Progress bar -->
<div style="max-width:1400px;margin:20px auto;padding:0 80px;">
  <div style="background:#f1f5f9;border:1px solid #cbd5e1;border-radius:12px;padding:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <span style="font-size:13px;font-weight:600;color:#0f172a;">Progress</span>
      <span id="progressText" style="font-size:12px;color:#64748b;">0/2 Questions Saved</span>
    </div>
    <div style="background:#e2e8f0;border-radius:8px;height:12px;overflow:hidden;">
      <div id="progressBar" style="background:linear-gradient(90deg,#10b981,#059669);height:100%;width:0%;transition:width 0.5s ease;"></div>
    </div>
  </div>
</div>
<main class="pink-app fade-in" id="appRoot" data-task="task1">
  <h1 class="hero">Know Your Network. Own Your Shift.
    <span class="sparkles" aria-hidden="true">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="4" stroke="#FF5CA8" stroke-width="2"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3M5 5l2.2 2.2M16.8 16.8 19 19M5 19l2.2-2.2M16.8 7.2 19 5" stroke="#FF8CC1" stroke-width="2" stroke-linecap="round"/></svg>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 4l1.8 3.6L18 8.4l-3 3 0.7 4.2L12 13.6l-3.7 2 0.7-4.2-3-3 4.2-.8L12 4z" stroke="#FF72B0" stroke-width="1.4" fill="none"/></svg>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="2" stroke="#FF5CA8" stroke-width="2"/><path d="M12 6v2M12 16v2M6 12h2M16 12h2" stroke="#FF5CA8" stroke-width="1.6" stroke-linecap="round"/></svg>
    </span>
  </h1>
  <p class="hero-sub">Fast, friendly drills for everyday NOC realities. Evidence first, clarity always.</p>

  <section class="task-shell" id="taskShell">
    <div class="task-head" style="justify-content:flex-end;">
      <!-- Removed in-browser Save button (editor removed) -->
    </div>
    <!-- Task Slider Container -->
    <div style="margin-top:30px;">
      <!-- Slide Navigation -->
      <div style="display:flex;justify-content:flex-start;gap:12px;margin-bottom:20px;padding-left:80px;">
        <button onclick="goToTaskSlide(0)" id="taskSlideBtn0" style="padding:12px 28px;border-radius:10px;border:2px solid #86efac;background:#dcfce7;color:#047857;font-weight:700;cursor:pointer;transition:all 0.25s;font-size:16px;box-shadow:0 2px 8px rgba(16,185,129,0.2);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.35)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(16,185,129,0.2)'">üìù Question 1</button>
        <button onclick="goToTaskSlide(1)" id="taskSlideBtn1" style="padding:12px 28px;border-radius:10px;border:2px solid #cbd5e1;background:#f1f5f9;color:#64748b;font-weight:700;cursor:pointer;transition:all 0.25s;font-size:16px;box-shadow:0 2px 8px rgba(100,116,139,0.15);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(100,116,139,0.25)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(100,116,139,0.15)'">üîç Question 2</button>
      </div>
      
      <!-- Slides Container -->
      <div id="taskSliderContainer" style="position:relative;overflow:visible;width:100%;padding-bottom:40px;">
        <div id="taskSlidesWrapper" style="display:flex;transition:transform 0.5s ease;width:200%;align-items:flex-start;">
          
          <!-- Slide 1: Question 1 with Topology Chat -->
          <div class="task-slide" style="width:100%;flex-shrink:0;box-sizing:border-box;padding-bottom:30px;">
            <div class="chat-wrap" id="chatWrap" style="margin-bottom:16px;min-height:auto;padding:10px 0 6px;">
              <ol class="chat-scroll" id="chatLog" aria-live="polite"></ol>
            </div>
            <div style="background:#dcfce7;border:1px solid #86efac;padding:18px 24px;border-radius:16px;margin:0 auto 0 80px;max-width:1200px;box-shadow:0 4px 14px -6px rgba(16,185,129,.25);">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <p style="margin:0;font-size:17px;line-height:1.6;color:#064e3b;font-weight:700;">
                  <strong>Question 1:</strong>
                  Add a clear network diagram showing the branch traffic flow and include a concise note describing the direction of user web traffic ‚Äî <span style="text-decoration:underline;">like your manager requested</span>.
                </p>
                <button class="save-progress-btn" data-question="1" style="background:#10b981;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;">Save Progress</button>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;">
                <label style="font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:#047857;">Network Diagram & Traffic Flow</label>
                <div id="editor-diagram" data-task-id="task1.q1" style="min-height:140px;width:100%;box-sizing:border-box;"></div>
              </div>
              <div style="margin-top:6px;font-size:10px;color:#065f46;">Autosaves locally + to server (versioned). Include the same content in your final PDF if required.</div>
            </div>
          </div>
          
          <!-- Slide 2: Question 2 with Osaka Slowdown Chat and Terminals -->
          <div class="task-slide" style="width:100%;flex-shrink:0;box-sizing:border-box;min-height:auto;padding-bottom:30px;">
            <div id="nocChat" class="chat-wrap" style="margin-bottom:20px;min-height:auto;">
              <ol class="chat-scroll" id="nocChatLog" aria-live="polite"></ol>
            </div>

            <div style="background:#1e1e1e;border:1px solid #333;border-radius:12px;padding:20px;margin-bottom:30px;">
              <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
                <button onclick="switchTerminal('tokyo')" id="tab-tokyo" style="background:#4ec9b0;color:#1e1e1e;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">Tokyo Branch</button>
                <button onclick="switchTerminal('osaka')" id="tab-osaka" style="background:#2d2d2d;color:#ccc;border:1px solid #444;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">Osaka Branch</button>
                <button onclick="switchTerminal('kyoto')" id="tab-kyoto" style="background:#2d2d2d;color:#ccc;border:1px solid #444;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">Kyoto Branch</button>
              </div>
              <div style="position:relative;height:500px;">
                <iframe id="term-tokyo" src="/api/terminal/branch-tokyo" style="width:100%;height:100%;border:1px solid #333;border-radius:8px;background:#0a0a0a;display:block;"></iframe>
                <iframe id="term-osaka" src="/api/terminal/branch-osaka" style="width:100%;height:100%;border:1px solid #333;border-radius:8px;background:#0a0a0a;display:none;"></iframe>
                <iframe id="term-kyoto" src="/api/terminal/branch-kyoto" style="width:100%;height:100%;border:1px solid #333;border-radius:8px;background:#0a0a0a;display:none;"></iframe>
              </div>
              <div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;">
                <button onclick="downloadTerminalHistory('tokyo')" id="download-tokyo" style="background:#047857;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);transition:all 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#047857'">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                  Download Tokyo History
                </button>
                <button onclick="downloadTerminalHistory('osaka')" id="download-osaka" style="background:#047857;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;display:none;align-items:center;gap:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);transition:all 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#047857'">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                  Download Osaka History
                </button>
                <button onclick="downloadTerminalHistory('kyoto')" id="download-kyoto" style="background:#047857;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;display:none;align-items:center;gap:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);transition:all 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#047857'">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                  Download Kyoto History
                </button>
              </div>
            </div>

            <div style="background:#dcfce7;border:1px solid #86efac;padding:18px 24px;border-radius:18px;margin:40px auto 20px 80px;max-width:1200px;box-shadow:0 4px 14px -6px rgba(16,185,129,.25);">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
                <p style="margin:0;font-size:18px;line-height:1.6;color:#064e3b;font-weight:700;flex:1;">
                  <strong>Question 2:</strong>
                  Document your branch performance investigation. Capture key command outputs for <strong>Tokyo</strong>, <strong>Kyoto</strong>, and <strong>Osaka</strong>, summarize what each shows, and state the most likely cause of the Osaka slowdown.
                </p>
                <button class="save-progress-btn" data-question="2" style="background:#10b981;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;margin-left:12px;">Save Progress</button>
              </div>
              <div style="display:flex;flex-direction:column;gap:10px;">
                <label style="font-size:12px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:#047857;">Branch Performance Investigation</label>
                <div id="editor-investigation" data-task-id="task1.investigation" style="min-height:350px;width:100%;box-sizing:border-box;"></div>
              </div>
              <div style="margin-top:10px;font-size:11px;color:#065f46;">Autosaves locally + to server. Include the same content in your consolidated DOCX/PDF.</div>
            </div>
          </div>
          
        </div>
        
        <!-- Arrow Navigation -->
        <button onclick="previousTaskSlide()" style="position:absolute;left:10px;top:40%;transform:translateY(-50%);background:rgba(6,78,59,0.9);color:#fff;border:2px solid #86efac;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:all 0.3s;z-index:10;" onmouseover="this.style.background='#047857'" onmouseout="this.style.background='rgba(6,78,59,0.9)'">‚Äπ</button>
        <button onclick="nextTaskSlide()" style="position:absolute;right:10px;top:40%;transform:translateY(-50%);background:rgba(6,78,59,0.9);color:#fff;border:2px solid #86efac;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:all 0.3s;z-index:10;" onmouseover="this.style.background='#047857'" onmouseout="this.style.background='rgba(6,78,59,0.9)'">‚Ä∫</button>
      </div>
      
      <!-- Slide Indicator -->
      <div style="text-align:center;margin-top:20px;font-size:14px;color:#047857;font-weight:600;">
        <span id="taskSlideIndicator">1 / 2</span>
      </div>
    </div>
    <!-- Removed notes/checklist/export section -->
  </section>
</main>
<!-- CKEditor script removed -->
<script src="/exam-protection.js"></script>
<script>
// --- Data Keys ---
const STORAGE_KEY='task1_state_v1';
let state={chat:[],uploads:[],rte:''};
// --- Seeded Conversation (trimmed) ---
function candidateName(){return localStorage.getItem('candidateName')||'Candidate';}
function managerMessageText(){return 'Add a quick topology sketch (ASCII or screenshot) and a short note describing the flow. Please draw a topology diagram.';}
const seeded=[
  {role:'client',time:'08:17',text:'We have slow web browsing. We have 3 branches: Tokyo, Osaka, Kyoto. Each branch has an EDGE router. All three go to the same VeloCloud Gateway (VC-GW), and from there to Harmony Connect (internet/security). Please show how traffic flows.'},
  {role:'teammate',time:'08:18',text:'Correct‚Äîsame VC-GW for all three branches.'},
  {role:'manager',time:'08:18',text:'Add a quick topology sketch (ASCII or screenshot) and a short note describing the flow. Please draw a topology diagram.'}
];
function load(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(raw){
      state=Object.assign(state,JSON.parse(raw));
      // Migration: trim any legacy prompt/system lines from earlier version
      if(Array.isArray(state.chat)){
        const filtered=state.chat.filter(m=>['client','teammate','manager','you'].includes(m.role));
        // Ensure first three are the seeded scenario roles (client, teammate, manager)
        const hasManager=filtered.some(m=>m.role==='manager');
        if(filtered.length>3 || !hasManager){
          state.chat=[...seeded];
        } else {
          // Keep only first occurrence of each of the three initial roles in order
          const order=['client','teammate','manager'];
          const firstThree=[];
            for(const r of order){
              const found=filtered.find(m=>m.role===r);
              if(found) firstThree.push(found);
            }
          state.chat=[...firstThree, ...filtered.filter(m=>!order.includes(m.role))];
        }
      } else {
        state.chat=[...seeded];
      }
    } else {
      state.chat=[...seeded];
      save();
    }
  }catch(e){
    console.warn('load fail',e);state.chat=[...seeded];
  }
}
function save(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}catch(e){console.warn('save fail',e);} }
// Enhanced save to persist function-based manager text
// (Wrapper added below definition to avoid duplicate name confusion)
function saveEnhanced(){
  try{
    const chatOut=state.chat.map(m=>{
      if(typeof m.text==='function') return {...m,text:m.text()};
      if(m.role==='manager' && (!m.text || !m.text.trim())) return {...m,text:(typeof managerMessageText==='function'?managerMessageText():m.text)};
      return m;
    });
    localStorage.setItem(STORAGE_KEY,JSON.stringify({...state,chat:chatOut}));
  }catch(e){console.warn('save fail',e);} 
}
// Swap references
save = saveEnhanced;

// --- Chat Rendering ---
const chatLog=document.getElementById('chatLog');
function renderChat(){chatLog.innerHTML='';state.chat.forEach((m,i)=>{chatLog.appendChild(renderMsg(m,i));});chatLog.scrollTop=chatLog.scrollHeight;}
function renderMsg(m,i){const roleClass = (m.role==='you')?'right': 'left';
  const li=document.createElement('li');li.className='msg '+roleClass+' '+m.role+(m.role==='system'?' system':'')+(m.role==='manager'?' manager':'')+(m.tag? (' '+m.tag.toLowerCase()):'');
const av=document.createElement('div');av.className='avatar';li.appendChild(av);
const bub=document.createElement('div');bub.className='bubble';const hdr=document.createElement('header');
const label=roleLabel(m.role,m);if(m.role!=='noc-header'){hdr.textContent=label+(label?' ‚Ä¢ ':'')+(m.time||timeNow());if(m.tag){const span=document.createElement('span');span.className='tag';span.textContent=m.tag;hdr.appendChild(document.createTextNode(' '));hdr.appendChild(span);}}bub.appendChild(hdr);
const p=document.createElement('p');
let txt=m.text; 
if(typeof txt==='function'){ try{ txt=txt(); }catch(e){ txt=''; } }
if(m.role==='manager' && (!txt || !txt.trim())){ txt=managerMessageText(); }
p.textContent=txt; bub.appendChild(p); li.appendChild(bub); return li;}
function avatarText(role){if(role==='client') return 'CL'; if(role==='teammate') return 'NT'; if(role==='system') return 'SYS'; if(role==='prompt') return 'PR'; if(role==='manager') return 'MG'; return 'YOU';}
function roleLabel(role,msg){if(role==='client') return 'Client'; if(role==='teammate') return 'Teammate'; if(role==='system') return 'System'; if(role==='prompt') return 'Prompt'; if(role==='manager') return 'Manager'; if(msg && msg.name) return msg.name; if(role==='noc-header') return ''; return 'You';}
function timeNow(){const d=new Date();return d.toTimeString().slice(0,5);} 

// (Composer removed per requirement)
function mirrorToNotes(txt){/* no-op now */}

// --- Escape utility ---
function escapeHtml(str){return str.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}

// (Tabs removed)

// (Editor, uploads, and local save logic removed for file-based submission model)

function updateProgress(){} // disabled

// --- Restore ---
function restore(){
  renderChat();
  // Editor removed; nothing to initialize here.
}

// --- Init ---
load();restore();
// ---------------- Branch Terminal Simulation ----------------
// Terminal switching function
function switchTerminal(branch){
  const tabs=['tokyo','osaka','kyoto'];
  tabs.forEach(t=>{
    const tab=document.getElementById('tab-'+t);
    const term=document.getElementById('term-'+t);
    const downloadBtn=document.getElementById('download-'+t);
    if(t===branch){
      tab.style.background='#4ec9b0';
      tab.style.color='#1e1e1e';
      tab.style.border='none';
      term.style.display='block';
      if(downloadBtn) downloadBtn.style.display='flex';
    }else{
      tab.style.background='#2d2d2d';
      tab.style.color='#ccc';
      tab.style.border='1px solid #444';
      term.style.display='none';
      if(downloadBtn) downloadBtn.style.display='none';
    }
  });
}

// Terminal history storage
const terminalHistory = {
  tokyo: [],
  osaka: [],
  kyoto: []
};

// Function to capture terminal output
function captureTerminalOutput(branch, content) {
  if (!terminalHistory[branch]) terminalHistory[branch] = [];
  const timestamp = new Date().toISOString();
  terminalHistory[branch].push({ timestamp, content });
}

// Download terminal history
function downloadTerminalHistory(branch) {
  // First try to get server-side history via API
  fetch(`/api/terminal/${branch}/history`)
    .then(response => {
      if (response.ok) {
        return response.text();
      }
      throw new Error('Server history not available');
    })
    .then(serverHistory => {
      // Download server history
      const blob = new Blob([serverHistory], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `terminal-history-${branch}-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showDownloadConfirmation(branch);
    })
    .catch(err => {
      // Fallback to client-side history
      const history = terminalHistory[branch] || [];
      let content = `=== Terminal History for ${branch.toUpperCase()} Branch ===\n`;
      content += `Downloaded: ${new Date().toLocaleString()}\n`;
      content += `Total entries: ${history.length}\n`;
      content += `${'='.repeat(60)}\n\n`;
      
      if (history.length === 0) {
        content += 'No terminal commands recorded yet.\n\n';
        content += 'TIP: The terminal history will capture commands and outputs as you interact with the terminal.\n';
        content += 'NOTE: If the terminal is on a different server, history may need to be downloaded directly from the terminal.\n';
      } else {
        history.forEach((entry, index) => {
          content += `[${index + 1}] ${new Date(entry.timestamp).toLocaleString()}\n`;
          content += `${entry.content}\n`;
          content += `${'-'.repeat(60)}\n\n`;
        });
      }
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `terminal-history-${branch}-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showDownloadConfirmation(branch);
    });
}

function showDownloadConfirmation(branch) {
  const btn = document.getElementById('download-' + branch);
  const originalText = btn.innerHTML;
  btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Downloaded!';
  btn.style.background = '#10b981';
  setTimeout(() => {
    btn.innerHTML = originalText;
    btn.style.background = '#047857';
  }, 2000);
}

// Slider functionality
let currentTaskSlide = 0;
const totalTaskSlides = 2;

function updateTaskSlider() {
  const wrapper = document.getElementById('taskSlidesWrapper');
  const indicator = document.getElementById('taskSlideIndicator');
  
  // Update transform
  wrapper.style.transform = `translateX(-${currentTaskSlide * 100}%)`;
  
  // Update indicator
  indicator.textContent = `${currentTaskSlide + 1} / ${totalTaskSlides}`;
  
  // Update button styles with enhanced active state
  for(let i = 0; i < totalTaskSlides; i++) {
    const btn = document.getElementById(`taskSlideBtn${i}`);
    if(i === currentTaskSlide) {
      // Active button - vibrant green with animation
      btn.style.background = 'linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)';
      btn.style.border = '3px solid #10b981';
      btn.style.color = '#047857';
      btn.style.boxShadow = '0 4px 16px rgba(16,185,129,0.4), 0 0 0 3px rgba(16,185,129,0.1)';
      btn.style.fontWeight = '800';
      btn.style.transform = 'scale(1.05)';
    } else {
      // Inactive button - neutral gray
      btn.style.background = '#f1f5f9';
      btn.style.border = '2px solid #cbd5e1';
      btn.style.color = '#64748b';
      btn.style.boxShadow = '0 2px 8px rgba(100,116,139,0.15)';
      btn.style.fontWeight = '700';
      btn.style.transform = 'scale(1)';
    }
  }
}

function goToTaskSlide(index) {
  currentTaskSlide = index;
  updateTaskSlider();
}

function nextTaskSlide() {
  currentTaskSlide = (currentTaskSlide + 1) % totalTaskSlides;
  updateTaskSlider();
}

function previousTaskSlide() {
  currentTaskSlide = (currentTaskSlide - 1 + totalTaskSlides) % totalTaskSlides;
  updateTaskSlider();
}

// Initialize slider
updateTaskSlider();

// Listen for messages from parent window (manager view)
window.addEventListener('message', function(event) {
  if (event.data && event.data.type === 'switchSlide') {
    const slideIndex = event.data.slideIndex;
    if (typeof slideIndex === 'number' && slideIndex >= 0 && slideIndex < totalTaskSlides) {
      goToTaskSlide(slideIndex);
    }
  }
});

// Save Progress functionality
function saveTaskProgress() {
  // Get current completed tasks
  let completedTasks = JSON.parse(localStorage.getItem('examTasksCompleted') || '[]');
  
  // Add task1 if not already completed
  if (!completedTasks.includes('task1')) {
    completedTasks.push('task1');
    localStorage.setItem('examTasksCompleted', JSON.stringify(completedTasks));
    
    // Show success message
    const msg1 = document.getElementById('progressMessage');
    const msg2 = document.getElementById('progressMessage2');
    if (msg1) msg1.textContent = '‚úì Progress saved! Task 1 marked as complete.';
    if (msg2) msg2.textContent = '‚úì Progress saved! Task 1 marked as complete.';
    
    // Hide message after 3 seconds
    setTimeout(() => {
      if (msg1) msg1.textContent = '';
      if (msg2) msg2.textContent = '';
    }, 3000);
    
    // Trigger storage event for other tabs
    window.dispatchEvent(new Event('storage'));
  } else {
    // Already completed
    const msg1 = document.getElementById('progressMessage');
    const msg2 = document.getElementById('progressMessage2');
    if (msg1) msg1.textContent = '‚úì Task already marked as complete.';
    if (msg2) msg2.textContent = '‚úì Task already marked as complete.';
    
    setTimeout(() => {
      if (msg1) msg1.textContent = '';
      if (msg2) msg2.textContent = '';
    }, 3000);
  }
}

// Analysis editor removed.

// Add NOC conversation messages for slide 2
const nocMessages = [
  {role:'client',time:'09:01',text:'Users in Osaka report slow web browsing. Tokyo and Kyoto are normal.',name:'Kenji (Japan Bank IT)'},
  {role:'teammate',time:'09:02',text:'No planned changes on our side. All three branches share the same upstream.',name:'Ava (Teammate)'},
  {role:'manager',time:'09:03',text:'please verify the reported browsing slowdown using the three branch terminals (Tokyo, Osaka, Kyoto). Measure only‚Äîno configuration changes. Terminals accept whitelisted commands; type help in any tab to see what\'s available. From each terminal, run your standard checks, capture screenshots/transcripts, and submit one sentence on where the slowdown most likely sits.',name:'Manager'}
];

const nocChatLog = document.getElementById('nocChatLog');
// Display NOC messages immediately
nocMessages.forEach((msg, index) => {
  nocChatLog.appendChild(renderMsg(msg, index));
});
nocChatLog.scrollTop = nocChatLog.scrollHeight;

// (Analysis editor code removed)
</script>
<script>
(function(){
  const brand=document.getElementById('brandNav');
  if(brand){
    brand.style.cursor='pointer';
    brand.addEventListener('click',()=>{
      const slug=localStorage.getItem('candidateSlug');
      const hub=localStorage.getItem('candidateHubToken');
      if(slug && hub){ location.href='/c/'+slug+'/'+hub; } else { location.href='/tasks.html'; }
    });
  }
})();
</script>
<script src="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.umd.js"></script>
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.css" />

<script src="/header-timer.js" defer></script>
<script src="/answer-sync.js" defer></script>
<!-- answer-save.js reference removed (no in-browser drafting) -->
<script>
// Initialize CKEditor for Task 1 investigation fields
(function(){
  // Wait for CKEditor to load with timeout
  let attempts = 0;
  const maxAttempts = 50; // 5 seconds max wait
  
  // Check if viewing as manager and edit mode
  const urlParams = new URLSearchParams(window.location.search);
  const isManagerView = urlParams.get('view') === 'manager';
  const editMode = urlParams.get('edit') === '1';
  
  // Check parent window for edit mode if in iframe
  let parentEditMode = false;
  try {
    if (window.parent && window.parent !== window) {
      const parentParams = new URLSearchParams(window.parent.location.search);
      parentEditMode = parentParams.get('edit') === '1';
    }
  } catch (e) {
    // Cross-origin, ignore
  }
  
  const isEditMode = editMode || parentEditMode;
  
  // Add body class for manager view styling
  if (isManagerView) {
    document.body.classList.add('manager-view');
    console.log('Manager view mode activated', isEditMode ? '(EDIT MODE)' : '(READ-ONLY)');
  }
  
  function initEditors() {
    if (window.CKEDITOR && window.CKEDITOR.ClassicEditor) {
      const { ClassicEditor, Essentials, Paragraph, Bold, Italic, Underline, Link, List, Image, ImageUpload, Base64UploadAdapter, Heading, BlockQuote, Table, MediaEmbed, CodeBlock, Code } = window.CKEDITOR;

      const editorConfigs = [
        { id: 'editor-diagram', taskId: 'task1.q1', placeholder: 'Describe topology and user traffic direction...' },
        { id: 'editor-investigation', taskId: 'task1.investigation', placeholder: 'Document your findings for Tokyo, Kyoto, and Osaka branches. Include command outputs, observations, and root cause analysis...' }
      ];

      editorConfigs.forEach(config => {
        ClassicEditor
          .create(document.getElementById(config.id), {
            plugins: [
              Essentials, Paragraph, Bold, Italic, Underline, Link, List, 
              Image, ImageUpload, Base64UploadAdapter, Heading, BlockQuote, Table, MediaEmbed, CodeBlock, Code
            ],
            toolbar: [
              'heading', '|',
              'bold', 'italic', 'underline', 'code', '|',
              'link', 'bulletedList', 'numberedList', '|',
              'imageUpload', 'blockQuote', 'codeBlock', 'insertTable', '|',
              'undo', 'redo'
            ],
            heading: {
              options: [
                { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
              ]
            },
            image: {
              toolbar: ['imageTextAlternative']
            },
            codeBlock: {
              languages: [
                { language: 'plaintext', label: 'Plain text' },
                { language: 'bash', label: 'Bash' },
                { language: 'python', label: 'Python' },
                { language: 'json', label: 'JSON' }
              ]
            },
            placeholder: config.placeholder
          })
          .then(editor => {
            console.log('CKEditor initialized:', config.id);
            window[config.id] = editor;
            
            // Make read-only in manager view ONLY if not in edit mode
            if (isManagerView && !isEditMode) {
              editor.enableReadOnlyMode(config.id);
              console.log('Editor set to read-only for manager view:', config.id);
            } else if (isEditMode) {
              console.log('Editor editable (edit mode active):', config.id);
            }
          })
          .catch(error => {
            console.error('CKEditor initialization error for', config.id, error);
            fallbackToTextarea(config);
          });
      });
    } else if (attempts < maxAttempts) {
      attempts++;
      setTimeout(initEditors, 100);
    } else {
      // Fallback to textareas after timeout
      console.warn('CKEditor failed to load, using simple textareas');
      [
        { id: 'editor-diagram', placeholder: 'Describe topology and user traffic direction...' },
        { id: 'editor-investigation', placeholder: 'Document your findings for Tokyo, Kyoto, and Osaka branches...' }
      ].forEach(fallbackToTextarea);
    }
  }
  
  function fallbackToTextarea(config) {
    const el = document.getElementById(config.id);
    if (el) {
      const textarea = document.createElement('textarea');
      textarea.id = config.id;
      textarea.name = config.id;
      textarea.placeholder = config.placeholder;
      textarea.style.cssText = 'width:100%;min-height:200px;padding:12px;border:1px solid #d1d5db;border-radius:8px;font-family:inherit;font-size:14px;line-height:1.6;';
      el.parentNode.replaceChild(textarea, el);
    }
  }
  
  // Start initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEditors);
  } else {
    initEditors();
  }
})();

// Terminal history capture via postMessage
window.addEventListener('message', function(event) {
  // Listen for terminal output from iframe terminals
  if (event.data && event.data.type === 'terminal-output') {
    const branch = event.data.branch;
    const content = event.data.content;
    if (branch && content) {
      captureTerminalOutput(branch, content);
    }
  }
});

// Clear all terminals on page load
function clearAllTerminals() {
  const branches = ['tokyo', 'osaka', 'kyoto'];
  branches.forEach(branch => {
    const iframe = document.getElementById('term-' + branch);
    if (iframe && iframe.contentWindow) {
      // Send clear command via postMessage to the terminal iframe
      iframe.contentWindow.postMessage({ type: 'terminal-command', command: 'clear\n' }, '*');
    }
  });
  // Clear local history as well
  terminalHistory.tokyo = [];
  terminalHistory.osaka = [];
  terminalHistory.kyoto = [];
  console.log('Clear command sent to all terminals');
}

// Clear local history on page load and send clear command
window.addEventListener('load', function() {
  // Wait for iframes to fully load before sending clear
  setTimeout(() => {
    clearAllTerminals();
  }, 1500);
});

// Periodic capture from terminal iframes (fallback method)
setInterval(() => {
  ['tokyo', 'osaka', 'kyoto'].forEach(branch => {
    try {
      const iframe = document.getElementById('term-' + branch);
      if (iframe && iframe.contentWindow) {
        // Try to get terminal content if accessible
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (doc && doc.body) {
          const text = doc.body.innerText || doc.body.textContent;
          if (text && text.trim().length > 0) {
            const lastEntry = terminalHistory[branch].length > 0 
              ? terminalHistory[branch][terminalHistory[branch].length - 1].content 
              : '';
            if (text !== lastEntry) {
              captureTerminalOutput(branch, text);
            }
          }
        }
      }
    } catch (e) {
      // Cross-origin access blocked - terminals are on different origin
      // History will need to be captured server-side or via API
    }
  });
}, 5000);
</script>
<script>
// Progress tracking for Task 1
const savedQuestions = new Set();

function updateProgressBar() {
  const total = 2;
  const saved = savedQuestions.size;
  const percentage = (saved / total) * 100;
  
  document.getElementById('progressBar').style.width = percentage + '%';
  document.getElementById('progressText').textContent = saved + '/' + total + ' Questions Saved';
  
  // Update task progress when all questions are completed
  if (saved === total) {
    updateMainTaskProgress('casestudy', 100);
    markTaskComplete('task1');
  }
}

function updateMainTaskProgress(taskId, progressPercentage) {
  try {
    // Get current task progress
    const taskProgress = JSON.parse(localStorage.getItem('taskProgress') || '{}');
    
    // Update this task's progress to 100%
    taskProgress[taskId] = progressPercentage;
    
    // Save back to localStorage
    localStorage.setItem('taskProgress', JSON.stringify(taskProgress));
    
    console.log('Task progress updated:', taskId, progressPercentage + '%');
  } catch (e) {
    console.error('Error updating task progress:', e);
  }
}

function markTaskComplete(taskId) {
  try {
    // Get current completed tasks
    let completedTasks = JSON.parse(localStorage.getItem('examTasksCompleted') || '[]');
    
    // Add this task if not already completed
    if (!completedTasks.includes(taskId)) {
      completedTasks.push(taskId);
      localStorage.setItem('examTasksCompleted', JSON.stringify(completedTasks));
      console.log('Task marked complete:', taskId);
      
      // Trigger storage event for other tabs/windows
      window.dispatchEvent(new StorageEvent('storage', {
        key: 'examTasksCompleted',
        newValue: JSON.stringify(completedTasks)
      }));
    }
  } catch (e) {
    console.error('Error marking task complete:', e);
  }
}

// Save progress button handlers
document.querySelectorAll('.save-progress-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const questionNum = this.getAttribute('data-question');
    savedQuestions.add(questionNum);
    updateProgressBar();
    
    // Visual feedback
    this.textContent = '‚úì Saved';
    this.style.background = '#059669';
    setTimeout(() => {
      this.textContent = 'Save Progress';
      this.style.background = '#10b981';
    }, 2000);
  });
});

// Load saved progress from localStorage
const storedProgress = localStorage.getItem('task1Progress');
if (storedProgress) {
  try {
    const progress = JSON.parse(storedProgress);
    progress.forEach(q => savedQuestions.add(q));
    updateProgressBar();
  } catch (e) {
    console.error('Error loading progress:', e);
  }
}

// Save progress to localStorage on change
window.addEventListener('beforeunload', function() {
  localStorage.setItem('task1Progress', JSON.stringify([...savedQuestions]));
});
</script>
<script>
// Task 1 in-page submission UI removed; candidates now submit only final consolidated document elsewhere.
</script>
<script src="/simple-autosave.js?v=8" data-task-id="casestudy"></script>
<a href="/contact.html" class="help-fab" title="Questions? Reach the on-call engineer.">
  <img src="/help-contact.svg" width="38" height="38" alt="Contact" />
  <span class="help-label">Questions? Contact on-call.</span>
</a>
</body></html>
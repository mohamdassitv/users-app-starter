<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Candidate Monitor & Scoring</title>
  <link rel="stylesheet" href="/styles.css">
  <script>
    // Define functions early so inline onclick handlers can use them
    window.switchTask = function(task) {
      console.log('switchTask called:', task);
      if (window.switchTaskImpl) {
        window.switchTaskImpl(task);
      }
    };
    window.saveScore = function() {
      console.log('saveScore called');
      if (window.saveScoreImpl) {
        window.saveScoreImpl();
      }
    };
  </script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      background: #f3f4f6;
      font-family: system-ui, -apple-system, sans-serif;
      padding: 0;
      margin: 0;
    }
    
    .monitor-container {
      max-width: 100%;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: white;
      padding: 15px 20px;
      border-bottom: 2px solid #e5e7eb;
      flex-shrink: 0;
    }
    
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 20px;
      color: #111827;
    }
    
    .candidate-info {
      font-size: 13px;
      color: #6b7280;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    .sidebar {
      width: 280px;
      background: white;
      border-right: 2px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .task-nav {
      padding: 16px 12px;
    }
    
    .task-nav-item {
      display: block;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      transition: all 0.2s;
      text-decoration: none;
    }
    
    .task-nav-item:hover {
      background: #f3f4f6;
      border-color: #3b82f6;
    }
    
    .task-nav-item.active {
      background: #1f2937;
      color: white;
      border-color: #1f2937;
    }
    
    .scoring-section {
      border-top: 2px solid #e5e7eb;
      padding: 16px 12px;
      background: #fef3c7;
    }
    
    .scoring-title {
      font-size: 14px;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 12px;
    }
    
    .score-item {
      margin-bottom: 10px;
    }
    
    .score-label {
      font-size: 12px;
      color: #451a03;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
    }
    
    .score-input-group {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    .score-input {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid #d97706;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }
    
    .score-max {
      font-size: 12px;
      color: #92400e;
    }
    
    .total-score {
      margin-top: 16px;
      padding: 12px;
      background: #16a34a;
      color: white;
      border-radius: 8px;
      text-align: center;
      font-weight: 700;
      font-size: 16px;
    }
    
    .save-score-btn {
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      background: #1f2937;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    
    .save-score-btn:hover {
      background: #374151;
    }
    
    .task-iframe-container {
      flex: 1;
      background: white;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .task-header {
      background: #1f2937;
      color: white;
      padding: 12px 20px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #374151;
    }
    
    .task-iframe {
      flex: 1;
      width: 100%;
      border: none;
      background: white;
      pointer-events: auto;
    }
    
    .back-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 16px;
    }
    
    .back-btn:hover {
      background: #2563eb;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="monitor-container">
    <div class="header">
      <h1>
        <button class="back-btn" onclick="window.location.href='/manager.html'">‚Üê Back to Dashboard</button>
        üî¥ Live Candidate Monitor & Scoring
      </h1>
      <div class="candidate-info">
        <strong>Email:</strong> <span id="candidateEmail">Loading...</span>
        <span style="margin: 0 12px;">‚Ä¢</span>
        <strong>Session:</strong> <span id="sessionId">-</span>
        <span style="margin: 0 12px;">‚Ä¢</span>
        <span id="autoRefreshStatus" style="color: #10b981;">
          Auto-refresh every 5s
        </span>
        <span style="margin: 0 12px;">‚Ä¢</span>
        <span id="editModeIndicator" style="display:none;color:#10b981;font-weight:700;">
          ‚úèÔ∏è EDIT MODE ACTIVE
        </span>
      </div>
    </div>

    <div class="main-content">
      <!-- Sidebar with tasks and scoring -->
      <div class="sidebar">
        <div class="task-nav">
          <div class="task-nav-item active" data-task="casestudy" onclick="switchTask('casestudy')">
            üìù Case Study (10%)
          </div>
          <div class="task-nav-item" data-task="mail" onclick="switchTask('mail')">
            üìß Mail (10%)
          </div>
          <div class="task-nav-item" data-task="users" onclick="switchTask('users')">
            üë• Users (20%)
          </div>
          <div class="task-nav-item" data-task="alerts" onclick="switchTask('alerts')">
            üö® Alerts (20%)
          </div>
          <div class="task-nav-item" data-task="routing" onclick="switchTask('routing')">
            üåê Networking (20%)
          </div>
          <div class="task-nav-item" data-task="waf" onclick="switchTask('waf')">
            üõ°Ô∏è WAF (20%)
          </div>
        </div>

        <div class="scoring-section">
          <div class="scoring-title">üìä Score Assignment</div>
          
          <div class="score-item">
            <div class="score-label">
              <span>Case Study</span>
              <span>Weight: 10%</span>
            </div>
            <div class="score-input-group">
              <input type="number" class="score-input" id="score-casestudy" min="0" max="100" value="0" />
              <span class="score-max">/ 100</span>
            </div>
          </div>

          <div class="score-item">
            <div class="score-label">
              <span>Mail</span>
              <span>Weight: 10%</span>
            </div>
            <div class="score-input-group">
              <input type="number" class="score-input" id="score-mail" min="0" max="100" value="0" />
              <span class="score-max">/ 100</span>
            </div>
          </div>

          <div class="score-item">
            <div class="score-label">
              <span>Users</span>
              <span>Weight: 20%</span>
            </div>
            <div class="score-input-group">
              <input type="number" class="score-input" id="score-users" min="0" max="100" value="0" />
              <span class="score-max">/ 100</span>
            </div>
          </div>

          <div class="score-item">
            <div class="score-label">
              <span>Alerts</span>
              <span>Weight: 20%</span>
            </div>
            <div class="score-input-group">
              <input type="number" class="score-input" id="score-alerts" min="0" max="100" value="0" />
              <span class="score-max">/ 100</span>
            </div>
          </div>

          <div class="score-item">
            <div class="score-label">
              <span>Networking</span>
              <span>Weight: 20%</span>
            </div>
            <div class="score-input-group">
              <input type="number" class="score-input" id="score-routing" min="0" max="100" value="0" />
              <span class="score-max">/ 100</span>
            </div>
          </div>

          <div class="score-item">
            <div class="score-label">
              <span>WAF</span>
              <span>Weight: 20%</span>
            </div>
            <div class="score-input-group">
              <input type="number" class="score-input" id="score-waf" min="0" max="100" value="0" />
              <span class="score-max">/ 100</span>
            </div>
          </div>

          <div class="total-score" id="totalScore">
            Final Score: 0.00%
          </div>

          <button class="save-score-btn" onclick="saveScore()">
            üíæ Save Score
          </button>
        </div>
      </div>

      <!-- Main content area -->
      <div class="content-area">
        <div class="task-iframe-container">
          <div class="task-header">
            <span id="currentTaskTitle">üìù Case Study - Weight: 10%</span>
            <div id="questionNav" style="display:none;gap:8px;align-items:center;">
              <span style="color:#6b7280;font-size:13px;font-weight:600;">Questions:</span>
              <button onclick="switchQuestion(0)" id="questionBtn0" style="padding:8px 16px;border-radius:6px;border:2px solid #10b981;background:#dcfce7;color:#047857;font-weight:700;cursor:pointer;transition:all 0.2s;font-size:13px;">Q1</button>
              <button onclick="switchQuestion(1)" id="questionBtn1" style="padding:8px 16px;border-radius:6px;border:2px solid #cbd5e1;background:#f1f5f9;color:#64748b;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:13px;">Q2</button>
            </div>
            <span style="color: #10b981;">üî¥ Live View (Interactive)</span>
          </div>
          <iframe id="taskIframe" class="task-iframe"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get email and edit mode from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const candidateEmail = urlParams.get('email');
    const editMode = urlParams.get('edit') === '1';
    
    console.log('Candidate email from URL:', candidateEmail);
    
    if (!candidateEmail) {
      alert('Error: No candidate email specified in URL');
      window.location.href = '/manager.html';
      throw new Error('No email provided'); // Stop execution
    }

    // Update email display
    const emailElement = document.getElementById('candidateEmail');
    if (emailElement) {
      emailElement.textContent = candidateEmail;
      console.log('Email element updated');
    } else {
      console.error('candidateEmail element not found!');
    }
    
    // Show edit mode indicator if enabled
    if (editMode) {
      const editIndicator = document.getElementById('editModeIndicator');
      if (editIndicator) {
        editIndicator.style.display = 'inline';
      }
      console.log('Edit mode is ENABLED');
    }

    let candidateSlug = null;
    let taskTokens = null;
    let currentTask = 'casestudy';
    let scores = {
      casestudy: 0,
      mail: 0,
      users: 0,
      alerts: 0,
      routing: 0,
      waf: 0
    };
    
    const weights = {
      casestudy: 0.10,
      mail: 0.10,
      users: 0.20,
      alerts: 0.20,
      routing: 0.20,
      waf: 0.20
    };
    
    const taskNames = {
      casestudy: 'üìù Case Study - Weight: 10%',
      mail: 'üìß Mail - Weight: 10%',
      users: 'üë• Users - Weight: 20%',
      alerts: 'üö® Alerts - Weight: 20%',
      routing: 'üåê Networking - Weight: 20%',
      waf: 'üõ°Ô∏è WAF - Weight: 20%'
    };
    
    // Switch task view - Define FIRST before DOM interactions
    window.switchTaskImpl = function(task) {
      currentTask = task;
      
      // Update active nav item
      document.querySelectorAll('.task-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-task="${task}"]`).classList.add('active');
      
      // Update header
      document.getElementById('currentTaskTitle').textContent = taskNames[task];
      
      // Show/hide question navigation for casestudy task
      const questionNav = document.getElementById('questionNav');
      if (questionNav) {
        questionNav.style.display = (task === 'casestudy') ? 'flex' : 'none';
      }
      
      // Load task in iframe
      loadTaskInIframe(task);
    };
    
    // Switch question within casestudy task
    window.switchQuestion = function(questionIndex) {
      const iframe = document.getElementById('taskIframe');
      if (iframe && iframe.contentWindow) {
        // Send message to iframe to switch slides
        iframe.contentWindow.postMessage({ 
          type: 'switchSlide', 
          slideIndex: questionIndex 
        }, '*');
        
        // Update button styles
        for (let i = 0; i < 2; i++) {
          const btn = document.getElementById('questionBtn' + i);
          if (btn) {
            if (i === questionIndex) {
              btn.style.border = '2px solid #10b981';
              btn.style.background = '#dcfce7';
              btn.style.color = '#047857';
              btn.style.fontWeight = '700';
            } else {
              btn.style.border = '2px solid #cbd5e1';
              btn.style.background = '#f1f5f9';
              btn.style.color = '#64748b';
              btn.style.fontWeight = '600';
            }
          }
        }
      }
    };
    
    // Load task in iframe
    function loadTaskInIframe(task) {
      if (!candidateSlug || !taskTokens) {
        console.log('Waiting for candidate data...');
        return;
      }
      
      const token = taskTokens[task];
      if (token) {
        const iframe = document.getElementById('taskIframe');
        // Add edit=1 parameter if edit mode is enabled
        const editParam = editMode ? '&edit=1' : '';
        iframe.src = `/c/${candidateSlug}/${token}?view=manager${editParam}`;
        console.log('Loading task:', task, 'URL:', iframe.src, 'Edit mode:', editMode);
        
        // Show question nav if casestudy
        setTimeout(() => {
          const questionNav = document.getElementById('questionNav');
          if (questionNav) {
            questionNav.style.display = (task === 'casestudy') ? 'flex' : 'none';
          }
        }, 500);
      } else {
        console.error('No token found for task:', task);
      }
    }

    // Calculate total score
    function calculateTotalScore() {
      let total = 0;
      for (const task in scores) {
        total += scores[task] * weights[task];
      }
      document.getElementById('totalScore').textContent = `Final Score: ${total.toFixed(2)}%`;
      return total;
    }
    
    // Save score to backend
    window.saveScoreImpl = async function() {
      const totalScore = calculateTotalScore();
      
      try {
        const response = await fetch(`/api/manager/candidate/${encodeURIComponent(candidateEmail)}/score`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            scores: scores,
            totalScore: totalScore
          })
        });
        
        if (response.ok) {
          alert(`‚úÖ Score saved successfully!\n\nFinal Score: ${totalScore.toFixed(2)}%`);
        } else {
          throw new Error('Failed to save score');
        }
      } catch (error) {
        alert('‚ùå Failed to save score: ' + error.message);
      }
    };

    // Load candidate info
    async function loadCandidateInfo() {
      console.log('Loading candidate info...');
      try {
        console.log('Fetching /api/manager/finished-exams');
        const response = await fetch(`/api/manager/finished-exams`);
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('API error:', errorText);
          throw new Error(`Failed to load candidates: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('API response:', data);
        console.log('Looking for email:', candidateEmail);
        
        const candidate = data.candidates.find(c => 
          c.email.toLowerCase() === candidateEmail.toLowerCase()
        );
        
        console.log('Found candidate:', candidate);
        
        if (candidate) {
          candidateSlug = candidate.slug;
          taskTokens = candidate.taskTokens;
          console.log('Candidate slug:', candidateSlug);
          console.log('Task tokens:', taskTokens);
          
          document.getElementById('sessionId').textContent = candidateSlug.substring(0, 8);
          
          // Load saved scores if they exist
          if (candidate.scores) {
            scores = { ...scores, ...candidate.scores };
            Object.keys(scores).forEach(task => {
              const input = document.getElementById(`score-${task}`);
              if (input) input.value = scores[task];
            });
            calculateTotalScore();
          }
          
          // Load initial task
          loadTaskInIframe(currentTask);
          
          // Setup score input listeners after DOM is ready
          document.querySelectorAll('.score-input').forEach(input => {
            input.addEventListener('input', (e) => {
              const task = e.target.id.replace('score-', '');
              let value = parseInt(e.target.value) || 0;
              if (value < 0) value = 0;
              if (value > 100) value = 100;
              scores[task] = value;
              e.target.value = value;
              calculateTotalScore();
            });
          });
        } else {
          alert('Candidate not found: ' + candidateEmail);
          window.location.href = '/manager.html';
        }
      } catch (error) {
        console.error('Failed to load candidate info:', error);
        alert('Failed to load candidate info: ' + error.message);
      }
    }

    // Initial load
    loadCandidateInfo();

    // Auto-refresh iframe every 5 seconds
    setInterval(() => {
      const iframe = document.getElementById('taskIframe');
      if (iframe.src) {
        iframe.contentWindow.postMessage({ type: 'refresh' }, '*');
      }
    }, 5000);
  </script>
</body>
</html>

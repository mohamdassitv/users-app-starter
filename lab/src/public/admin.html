<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Exam Admin</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="/theme.css" />
<link rel="stylesheet" href="/styles.css" />
<style>
body{background:#fff;color:#222;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;}
.admin-wrap{max-width:1100px;margin:34px auto 90px;padding:0 34px;}
.panel{background:#ffffff;border:1px solid #ffd3e8;padding:26px 30px;border-radius:28px;margin-bottom:34px;box-shadow:0 6px 28px -10px rgba(255,92,168,.25),0 0 0 1px rgba(255,92,168,.25);} 
.panel h2{margin:0 0 14px;font-size:21px;letter-spacing:.04em;color:#c91863;font-weight:700;}
.panel label{display:block;font-size:12px;font-weight:600;letter-spacing:.5px;margin:16px 0 6px;color:#9a0f4c;text-transform:uppercase;}
.panel input[type=text], .panel textarea{width:100%;background:#fff;border:1px solid #ffbadb;color:#222;padding:10px 12px;border-radius:12px;font-size:13px;font-family:inherit;box-shadow:0 1px 0 0 #ffc2e2 inset;} 
.panel input[type=text]:focus, .panel textarea:focus{outline:2px solid #ff86c1;border-color:#ff86c1;}
.panel textarea{min-height:120px;resize:vertical;line-height:1.5;}
small.desc{display:block;font-size:11px;color:#b2497a;margin-top:4px;}
button.primary{background:linear-gradient(135deg,#ff5ca8,#ff92c5);color:#fff;border:none;padding:10px 22px;font-weight:700;border-radius:999px;cursor:pointer;letter-spacing:.8px;font-size:13px;box-shadow:0 4px 18px -6px rgba(255,92,168,.55);} 
button.primary:hover{filter:brightness(1.06);} 
.actions-line{display:flex;flex-wrap:wrap;gap:14px;margin-top:18px;}
.badge{display:inline-block;background:#ff5ca8;padding:4px 10px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:.6px;color:#fff;margin-left:10px;border:1px solid #ff8dbf;}
.notice{background:#fff4fa;color:#680f37;border:1px solid #ffb5da;padding:10px 14px;border-radius:16px;font-size:12px;}
.readout{font-family:ui-monospace,monospace;background:#fff;border:1px solid #ffd3e8;padding:12px 14px;border-radius:16px;white-space:pre-wrap;max-height:300px;overflow:auto;font-size:12px;color:#7b1f54;}
hr.div{border:none;height:1px;background:linear-gradient(90deg,transparent,#ffc7e3,transparent);margin:40px 0;}
table thead tr{color:#c91863;}
table tbody tr:nth-child(even){background:#fff7fb;}
</style>
</head>
<body>
<header class="site-header" id="siteHeader">
  <div class="brand" style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="location.href='/'">
    <img src="/logo.svg" alt="Logo" class="logo-img">
    <span class="brand-hacker">CHECK POINT</span>
  </div>
</header>
<main class="admin-wrap fade-in container">
  <h1 class="page-title">Exam Administration <span class="spark">✨</span></h1>
  <p class="muted" style="max-width:760px;">Protected controls for configuration and maintenance. Changes immediately affect active candidates. Keep distribution list updated. All actions require password verification (cached for session only).</p>

  <div class="panel card" id="sessionPanel" style="display:none;">
    <h2>Admin Session <span class="badge" id="authState">CHECK</span></h2>
    <p style="font-size:13px;line-height:1.5;" id="sessionMsg">Verifying session…</p>
    <div class="actions-line" id="sessionActions" style="display:none;">
  <button class="btn btn-primary" id="btnAdminLogout">Logout</button>
  <button class="btn btn-ghost" id="btnGoLogin" style="display:none;">Login</button>
    </div>
  </div>

  <div class="panel card" id="candidatesPanel" style="display:none;">
    <h2>Candidates <span class="badge" id="candCount" style="background:#1e293b;border-color:#334155;">0</span></h2>
    <div style="overflow:auto;max-height:260px;border:1px solid #1e2533;border-radius:14px;">
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead style="background:#132033;position:sticky;top:0;">
          <tr>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Name</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Email</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Status / Remaining</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Start</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Reset</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Delete</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">+Min</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Extend</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Final Work</th>
          </tr>
        </thead>
        <tbody id="candRows"></tbody>
      </table>
    </div>
    <div class="actions-line" style="margin-top:14px;">
  <button class="btn btn-ghost" id="btnReloadCandidates">Refresh</button>
  <button class="btn btn-primary" id="btnShowCreate" type="button">New Candidate</button>
    </div>
  <form id="createCandidateForm" style="display:none;margin-top:8px;padding:18px 20px;background:rgba(255,255,255,.75);border:1px solid var(--pink-200);border-radius:20px;backdrop-filter:blur(4px);">
      <div style="display:flex;flex-wrap:wrap;gap:10px;">
  <input id="newCandName" class="input" placeholder="Full Name" required style="flex:1;min-width:160px;" />
  <input id="newCandEmail" class="input" type="email" placeholder="email@example.com" required style="flex:1;min-width:200px;" />
  <button type="submit" class="btn btn-primary" style="background:linear-gradient(180deg,#10b981,#059669);">Save</button>
  <button type="button" id="btnCreateAndOpen" class="btn btn-primary">Save & Open Login</button>
  <button type="button" id="btnCancelCreate" class="btn btn-ghost" style="padding:0 18px;">Cancel</button>
      </div>
      <small id="createCandMsg" class="desc" style="margin-top:6px;"></small>
    </form>
    <small class="desc">Starts are idempotent; if a candidate already began their 4h window it will not reset.</small>
  </div>

  <!-- Config panel trimmed: only on-call contact retained -->
  <div class="panel card" id="configPanel" style="display:none;">
    <h2>Exam Config <span class="badge" id="configDirty" style="display:none;background:#b45309;border:1px solid #f59e0b;">UNSAVED</span></h2>
    <label for="onCall">On-Call Contact (phone or alias)</label>
    <input type="text" id="onCall" class="input" placeholder="+81-xxx-xxxx" />
    <div class="actions-line">
      <button class="btn btn-primary" id="btnSaveConfig">Save</button>
      <button class="btn btn-ghost" id="btnShowConfig">Reload</button>
    </div>
    <small class="desc">Used for internal reference only.</small>
  </div>

  <!-- Global maintenance panel removed per new per-candidate reset requirement -->
  <button type="button" class="floating-refresh" id="floatingRefresh" title="Refresh Candidates">⟳ Refresh</button>

  <div class="panel card" id="finalWorkPanel" style="display:none;">
    <h2>Final Work Review <span class="badge" id="finalWorkCount" style="background:#1e293b;border-color:#334155;">0</span></h2>
    <p class="muted" style="font-size:12px;margin-top:0;margin-bottom:10px;">Only candidates who submitted (final submit) appear here. Click View to inspect immutable snapshot.</p>
    <div style="overflow:auto;max-height:260px;border:1px solid #1e2533;border-radius:14px;">
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead style="background:#132033;position:sticky;top:0;">
          <tr>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Name</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Email</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Submitted At</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Duration Used</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">View</th>
          </tr>
        </thead>
        <tbody id="finalWorkRows"></tbody>
      </table>
    </div>
    <div class="actions-line" style="margin-top:14px;">
      <button class="btn btn-ghost" id="btnReloadFinalWork" type="button">Refresh</button>
    </div>
  </div>
</main>
<!-- Modal for viewing candidate final work (answers) -->
<div id="answersModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:4000;align-items:flex-start;justify-content:center;padding:60px 20px;overflow:auto;">
  <div style="background:#ffffff;border:2px solid #ffb6dc;box-shadow:0 10px 40px -10px rgba(0,0,0,.35);border-radius:28px;max-width:860px;width:100%;padding:30px 34px;position:relative;">
    <button id="closeAnswersModal" style="position:absolute;top:12px;right:12px;background:#ffe3f1;border:1px solid #ffadd7;color:#a10d55;padding:4px 10px;font-size:12px;border-radius:20px;cursor:pointer;">Close</button>
    <h2 style="margin:0 0 14px;font-size:22px;color:#c91863;">Candidate Final Work</h2>
    <div id="answersModalMeta" style="font-size:12px;color:#7a1e52;margin-bottom:14px;font-family:ui-monospace,monospace;"></div>
    <div id="answersModalBody" class="readout" style="max-height:500px;overflow:auto;background:#fff;border:1px solid #ffd3e8;">Loading…</div>
  </div>
</div>
<script>
// Admin page now expects cookie-based session established via /admin-login.html
// Still supports header fallback if needed (not used when cookie present)
let authToken=null;
// Minimal HTML escaper (was missing and caused candidate table to stay empty due to ReferenceError)
function escapeHtml(str){
  return String(str||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}
function gateFetch(url,opts={}){
  opts.headers = Object.assign(authToken? {'X-Admin-Password':authToken}: {}, opts.headers||{});
  return fetch(url, opts);
}
function showPanels(){
  document.getElementById('configPanel').style.display='block';
  document.getElementById('candidatesPanel').style.display='block';
  document.getElementById('finalWorkPanel').style.display='block';
}
async function verifySession(){
  // Try a cheap call that requires admin; use config endpoint
  const r = await gateFetch('/api/admin/config');
  const stateEl = document.getElementById('authState');
  const msgEl = document.getElementById('sessionMsg');
  const actions = document.getElementById('sessionActions');
  const btnLogin = document.getElementById('btnGoLogin');
  if(r.ok){
    stateEl.textContent='ACTIVE';
    stateEl.style.background='#065f46';
    stateEl.style.border='1px solid #059669';
    msgEl.textContent='Session authenticated via cookie.';
    actions.style.display='flex';
    btnLogin.style.display='none';
  showPanels();
  loadConfig();
  loadCandidates();
  } else {
    stateEl.textContent='NONE';
    stateEl.style.background='#7f1d1d';
    stateEl.style.border='1px solid #b91c1c';
    msgEl.innerHTML='No admin session. <strong>Use the Admin Login page.</strong>';
    actions.style.display='flex';
    document.getElementById('btnAdminLogout').style.display='none';
    btnLogin.style.display='inline-block';
  }
  document.getElementById('sessionPanel').style.display='block';
}
async function adminLogout(){
  await fetch('/api/auth/admin-logout',{method:'POST'});
  location.href='/admin-login.html';
}
document.getElementById('btnAdminLogout').addEventListener('click', adminLogout);
document.getElementById('btnGoLogin').addEventListener('click', ()=> location.href='/admin-login.html');
verifySession();

// Config save
const onCallEl=document.getElementById('onCall');
onCallEl.addEventListener('input',()=> document.getElementById('configDirty').style.display='inline-block');

document.getElementById('btnSaveConfig').addEventListener('click', async ()=>{
  const body={recipients: '', onCall: onCallEl.value};
  const r= await gateFetch('/api/admin/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(r.ok){ document.getElementById('configDirty').style.display='none'; }
});

document.getElementById('btnShowConfig').addEventListener('click', loadConfig);
async function loadConfig(){
  const r= await gateFetch('/api/admin/config');
  if(r.ok){ const j=await r.json(); onCallEl.value=j.onCall||''; document.getElementById('configDirty').style.display='none'; }
}

// Removed global reset logic

// Candidate list logic
async function loadCandidates(){
  const r = await gateFetch('/api/admin/candidates');
  if(!r.ok) return; const j = await r.json();
  document.getElementById('candCount').textContent=j.total;
  const tbody=document.getElementById('candRows');
  tbody.innerHTML='';
  j.candidates.sort((a,b)=> (a.startTime?1:0)-(b.startTime?1:0) || (a.name||'').localeCompare(b.name||''));
  loadCandidatesWrapperData(j.candidates);
  j.candidates.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;">'+escapeHtml(c.name||'')+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;font-family:ui-monospace,monospace;font-size:11px;">'+escapeHtml(c.email)+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;" data-rem="'+c.email+'">'+formatRemaining(c)+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;">'+(c.startTime? '<span style="font-size:10px;color:#b2497a;">—</span>' : '<button data-email="'+c.email+'" class="startBtn" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:4px 10px;border-radius:20px;font-size:11px;cursor:pointer;">Start</button>')+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;"><button data-reset="'+c.email+'" class="resetBtn" style="background:linear-gradient(135deg,#f97316,#fb923c);color:#fff;border:none;padding:4px 10px;border-radius:20px;font-size:11px;cursor:pointer;">Reset</button></td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;"><button data-delete="'+c.email+'" class="delBtn" title="Delete candidate" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;border:none;padding:4px 10px;border-radius:20px;font-size:11px;cursor:pointer;">Del</button></td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;"><input type="number" min="1" placeholder="+min" data-extend-input="'+c.email+'" style="width:58px;padding:2px 4px;font-size:11px;border:1px solid #ffbadb;border-radius:8px;" /></td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;"><button data-extend="'+c.email+'" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;border:none;padding:4px 8px;border-radius:14px;font-size:11px;cursor:pointer;">Add</button></td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;">'+(c.submittedAt? '<button data-view="'+c.email+'" style="background:linear-gradient(135deg,#9333ea,#6d28d9);color:#fff;border:none;padding:4px 10px;border-radius:18px;font-size:11px;cursor:pointer;">View</button> <button data-open="'+c.email+'" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;border:none;padding:4px 10px;border-radius:18px;font-size:11px;cursor:pointer;">Open</button>' : '<span style="font-size:10px;color:#b2497a;">—</span>')+'</td>';
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('.startBtn').forEach(btn=> btn.addEventListener('click', async (e)=>{
    const email=e.target.getAttribute('data-email');
    const r2= await gateFetch('/api/candidate/'+encodeURIComponent(email)+'/start',{method:'POST'});
    if(r2.ok){ loadCandidates(); }
  }));
  tbody.querySelectorAll('.resetBtn').forEach(btn=> btn.addEventListener('click', async e=>{
    const email=e.target.getAttribute('data-reset');
    if(!confirm('Reset candidate '+email+'?')) return;
    const r3=await gateFetch('/api/admin/candidate/'+encodeURIComponent(email)+'/reset',{method:'POST'});
    if(r3.ok) loadCandidates();
  }));
  // (Docx download buttons removed)
  tbody.querySelectorAll('.delBtn').forEach(btn=> btn.addEventListener('click', async e=>{
    const email=e.target.getAttribute('data-delete');
    if(!confirm('Delete candidate '+email+' and all their data?')) return;
    const r=await gateFetch('/api/admin/candidate/'+encodeURIComponent(email),{method:'DELETE'});
    if(r.ok) loadCandidates();
  }));
  tbody.querySelectorAll('[data-extend]').forEach(btn=> btn.addEventListener('click', async e=>{
    const email=e.target.getAttribute('data-extend');
    const inp=tbody.querySelector('[data-extend-input="'+CSS.escape(email)+'"]');
    const val=parseInt(inp && inp.value,10);
    if(!val || val<1) { alert('Enter minutes > 0'); return; }
    const r=await gateFetch('/api/admin/candidate/'+encodeURIComponent(email)+'/extend',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({minutes:val})});
    if(r.ok){ inp.value=''; loadCandidates(); }
  }));
  tbody.querySelectorAll('[data-view]').forEach(btn=> btn.addEventListener('click', e=>{
    const email=e.target.getAttribute('data-view');
    openAnswersModal(email);
  }));
  tbody.querySelectorAll('[data-open]').forEach(btn=> btn.addEventListener('click', e=>{
    const email=e.target.getAttribute('data-open');
    window.open('/candidate-view.html?email='+encodeURIComponent(email),'_blank');
  }));
  startTimerUpdates();
  buildFinalWork(j.candidates);
}
function formatRemaining(c){
  if(!c.startTime) return 'Not started';
  const ms=c.remainingMs; const h=Math.floor(ms/3600000); const m=Math.floor((ms%3600000)/60000); const s=Math.floor((ms%60000)/1000);
  return `${h}h ${m}m ${s}s` + (c.extraTimeMs? ' (+extra)': '');
}
let timerInterval=null;
function startTimerUpdates(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    document.querySelectorAll('[data-rem]').forEach(cell=>{
      const email=cell.getAttribute('data-rem');
      const rowData = currentCandidates[email.toLowerCase()];
      if(!rowData) return;
      if(!rowData.startTime) return; // not started
      const rem=computeRemainingLocal(rowData);
      rowData.remainingMs=rem.remainingMs;
      cell.textContent=formatRemaining(rowData);
    });
  },1000);
}
// Lightweight compute on client mirroring server logic
function computeRemainingLocal(c){
  const base=4*60*60*1000;
  const extra=c.extraTimeMs||0;
  const total=base+extra;
  if(!c.startTime) return {remainingMs: total};
  const elapsed=Date.now()-c.startTime;
  return {remainingMs: Math.max(0,total-elapsed)};
}
let currentCandidates={};
function loadCandidatesWrapperData(list){
  currentCandidates={};
  list.forEach(c=> currentCandidates[c.email.toLowerCase()]=c);
}
let candidatePollInterval=null;
function startCandidatePolling(){
  if(candidatePollInterval) clearInterval(candidatePollInterval);
  candidatePollInterval = setInterval(()=>{ loadCandidates(); }, 15000); // 15s
}
// Hook start after verification success (showPanels call)
const _origShowPanels = showPanels;
showPanels = function(){ _origShowPanels(); startCandidatePolling(); };

// ---- View-only answers modal ----
const answersModal = document.getElementById('answersModal');
const answersModalBody = document.getElementById('answersModalBody');
const answersModalMeta = document.getElementById('answersModalMeta');
document.getElementById('closeAnswersModal').addEventListener('click', ()=>{ answersModal.style.display='none'; });
answersModal.addEventListener('click', e=>{ if(e.target===answersModal) answersModal.style.display='none'; });

async function openAnswersModal(email){
  answersModal.style.display='flex';
  answersModalBody.textContent='Loading…';
  answersModalMeta.textContent='Candidate: '+email;
  try{
    // Try final snapshot first
    let ans = null; let submittedAt=null; let usedSnapshot=false;
    const rs = await gateFetch('/api/admin/candidate/'+encodeURIComponent(email)+'/final-work');
    if(rs.ok){
      const snap = await rs.json();
      if(snap && snap.snapshot){ ans = snap.snapshot.answers || {}; submittedAt=snap.submittedAt; usedSnapshot=true; }
    }
    if(!ans){
      const r = await gateFetch('/api/admin/candidate/'+encodeURIComponent(email)+'/answers');
      if(r.ok){ const j = await r.json(); ans = j.answers || {}; }
    }
    if(!ans || !Object.keys(ans).length){ answersModalBody.textContent='No answers yet.'; return; }
    const parts=[];
    if(submittedAt) parts.push('FINAL SUBMISSION at '+ new Date(submittedAt).toLocaleString() + (usedSnapshot? ' (snapshot)':'')+'\n');
    Object.entries(ans).forEach(([taskId,obj])=>{
      parts.push('### '+taskId+' (updated '+ new Date((obj && obj.updatedAt)||0).toLocaleString()+')');
      const fields=(obj && obj.fields)||{};
      Object.entries(fields).forEach(([k,v])=>{
        parts.push('\n'+k+':');
        let val = typeof v==='string'? v: JSON.stringify(v);
        val = val.replace(/<[^>]+>/g,'');
        parts.push(val.trim()? '  '+val.trim(): '  (empty)');
      });
      parts.push('\n');
    });
    answersModalBody.textContent=parts.join('\n');
  }catch(e){ answersModalBody.textContent='Error: '+e.message; }
}

// ---- Final Work Panel Logic ----
function buildFinalWork(candidates){
  const submitted = candidates.filter(c=> c.submittedAt);
  const tbody = document.getElementById('finalWorkRows');
  const countEl = document.getElementById('finalWorkCount');
  countEl.textContent=submitted.length;
  tbody.innerHTML='';
  submitted.sort((a,b)=> a.submittedAt - b.submittedAt);
  submitted.forEach(c=>{
    const usedMs = c.submittedAt - (c.startTime||c.submittedAt);
    const h=Math.floor(usedMs/3600000); const m=Math.floor((usedMs%3600000)/60000); const s=Math.floor((usedMs%60000)/1000);
    const tr=document.createElement('tr');
    tr.innerHTML=
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;">'+escapeHtml(c.name||'')+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;font-family:ui-monospace,monospace;font-size:11px;">'+escapeHtml(c.email)+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;">'+ new Date(c.submittedAt).toLocaleString() +'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;">'+h+'h '+m+'m '+s+'s</td>'+
  '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;"><button data-view-final="'+c.email+'" style="background:linear-gradient(135deg,#9333ea,#6d28d9);color:#fff;border:none;padding:4px 10px;border-radius:18px;font-size:11px;cursor:pointer;">View</button> <button data-open-final="'+c.email+'" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;border:none;padding:4px 10px;border-radius:18px;font-size:11px;cursor:pointer;">Open</button></td>';
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('[data-view-final]').forEach(btn=> btn.addEventListener('click', e=>{
    const email=e.target.getAttribute('data-view-final');
    openAnswersModal(email);
  }));
  tbody.querySelectorAll('[data-open-final]').forEach(btn=> btn.addEventListener('click', e=>{
    const email=e.target.getAttribute('data-open-final');
    window.open('/candidate-view.html?email='+encodeURIComponent(email),'_blank');
  }));
}
document.getElementById('btnReloadFinalWork').addEventListener('click', ()=> loadCandidates());
</script>
<script src="/collab-dock-simple.js?v=2" defer></script>
</body>
</html>
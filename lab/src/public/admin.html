<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Exam Admin</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="/theme.css" />
<link rel="stylesheet" href="/styles.css" />
<style>
body{background:#fff;color:#222;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;}
.admin-wrap{max-width:1100px;margin:34px auto 90px;padding:0 34px;}
.panel{background:#ffffff;border:1px solid #ffd3e8;padding:26px 30px;border-radius:28px;margin-bottom:34px;box-shadow:0 6px 28px -10px rgba(255,92,168,.25),0 0 0 1px rgba(255,92,168,.25);} 
.panel h2{margin:0 0 14px;font-size:21px;letter-spacing:.04em;color:#c91863;font-weight:700;}
.panel label{display:block;font-size:12px;font-weight:600;letter-spacing:.5px;margin:16px 0 6px;color:#9a0f4c;text-transform:uppercase;}
.panel input[type=text], .panel textarea{width:100%;background:#fff;border:1px solid #ffbadb;color:#222;padding:10px 12px;border-radius:12px;font-size:13px;font-family:inherit;box-shadow:0 1px 0 0 #ffc2e2 inset;} 
.panel input[type=text]:focus, .panel textarea:focus{outline:2px solid #ff86c1;border-color:#ff86c1;}
.panel textarea{min-height:120px;resize:vertical;line-height:1.5;}
small.desc{display:block;font-size:11px;color:#b2497a;margin-top:4px;}
button.primary{background:linear-gradient(135deg,#ff5ca8,#ff92c5);color:#fff;border:none;padding:10px 22px;font-weight:700;border-radius:999px;cursor:pointer;letter-spacing:.8px;font-size:13px;box-shadow:0 4px 18px -6px rgba(255,92,168,.55);} 
button.primary:hover{filter:brightness(1.06);} 
.actions-line{display:flex;flex-wrap:wrap;gap:14px;margin-top:18px;}
.badge{display:inline-block;background:#ff5ca8;padding:4px 10px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:.6px;color:#fff;margin-left:10px;border:1px solid #ff8dbf;}
.notice{background:#fff4fa;color:#680f37;border:1px solid #ffb5da;padding:10px 14px;border-radius:16px;font-size:12px;}
.readout{font-family:ui-monospace,monospace;background:#fff;border:1px solid #ffd3e8;padding:12px 14px;border-radius:16px;white-space:pre-wrap;max-height:300px;overflow:auto;font-size:12px;color:#7b1f54;}
hr.div{border:none;height:1px;background:linear-gradient(90deg,transparent,#ffc7e3,transparent);margin:40px 0;}
table thead tr{color:#c91863;}
table tbody tr:nth-child(even){background:#fff7fb;}

/* Loading Modal */
.loading-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);z-index:9999;display:none;align-items:center;justify-content:center;animation:fadeIn 0.3s ease-out;}
.loading-modal.show{display:flex;}
.loading-content{background:linear-gradient(135deg,#fff,#fff7fb);border:2px solid #ff5ca8;border-radius:28px;padding:50px 60px;text-align:center;box-shadow:0 20px 60px -10px rgba(255,92,168,0.5);animation:slideUp 0.4s ease-out;}
.loading-spinner{width:80px;height:80px;margin:0 auto 24px;border:6px solid #ffd3e8;border-top-color:#ff5ca8;border-radius:50%;animation:spin 1s linear infinite;}
.loading-text{font-size:18px;font-weight:700;color:#c91863;margin-bottom:12px;letter-spacing:0.5px;}
.loading-subtext{font-size:13px;color:#b2497a;line-height:1.6;max-width:380px;}
.loading-steps{margin-top:20px;text-align:left;font-size:12px;color:#7b1f54;line-height:1.8;}
.loading-step{padding:6px 0;opacity:0.5;transition:opacity 0.3s ease;}
.loading-step.active{opacity:1;font-weight:600;color:#ff5ca8;}
.loading-step.done{opacity:0.7;}
.loading-step.done::before{content:'‚úì ';color:#10b981;font-weight:700;}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes fadeIn{from{opacity:0;} to{opacity:1;}}
@keyframes slideUp{from{opacity:0;transform:translateY(30px);} to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>
<header class="site-header" id="siteHeader">
  <div class="brand" style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="location.href='/'">
    <img src="/logo.svg" alt="Logo" class="logo-img">
    <span class="brand-hacker">CHECK POINT</span>
  </div>
</header>
<main class="admin-wrap fade-in container">
  <h1 class="page-title">Exam Administration <span class="spark">‚ú®</span></h1>

  <div class="panel card" id="sessionPanel" style="display:none;">
    <h2>Admin Session <span class="badge" id="authState">CHECK</span></h2>
    <p style="font-size:13px;line-height:1.5;" id="sessionMsg">Verifying session‚Ä¶</p>
    <div class="actions-line" id="sessionActions" style="display:none;">
  <button class="btn btn-primary" id="btnAdminLogout">Logout</button>
  <button class="btn btn-ghost" id="btnGoLogin" style="display:none;">Login</button>
    </div>
  </div>

  <div class="panel card" id="candidatesPanel" style="display:none;">
  <h2>Active Candidates <span class="badge" id="candCount" style="background:#1e293b;border-color:#334155;">0</span></h2>
    <div style="overflow:auto;max-height:260px;border:1px solid #1e2533;border-radius:14px;">
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead style="background:#132033;position:sticky;top:0;">
          <tr>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Name</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Email</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Status / Remaining</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Start</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Reset</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Delete</th>
          </tr>
        </thead>
        <tbody id="candRows"></tbody>
      </table>
    </div>
    <div class="actions-line" style="margin-top:14px;">
  <button class="btn btn-ghost" id="btnReloadCandidates">Refresh</button>
  <button class="btn btn-primary" id="btnShowCreate" type="button">New Candidate</button>
  <button class="btn" id="btnDeleteAll" type="button" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;border:none;">Delete All Candidates</button>
    </div>
  <form id="createCandidateForm" style="display:none;margin-top:8px;padding:18px 20px;background:rgba(255,255,255,.75);border:1px solid var(--pink-200);border-radius:20px;backdrop-filter:blur(4px);">
      <div style="display:flex;flex-wrap:wrap;gap:10px;">
  <input id="newCandName" class="input" placeholder="Full Name" required style="flex:1;min-width:160px;" />
  <input id="newCandEmail" class="input" type="email" placeholder="email@example.com" required style="flex:1;min-width:200px;" />
  <button type="submit" class="btn btn-primary" style="background:linear-gradient(180deg,#10b981,#059669);">Save</button>
  <button type="button" id="btnCreateAndOpen" class="btn btn-primary">Save & Open Login</button>
  <button type="button" id="btnCancelCreate" class="btn btn-ghost" style="padding:0 18px;">Cancel</button>
      </div>
      <small id="createCandMsg" class="desc" style="margin-top:6px;"></small>
    </form>
    <small class="desc">Starts are idempotent; if a candidate already began their 2h window it will not reset.</small>
  </div>

  <!-- Config panel trimmed: only on-call contact retained -->
  <div class="panel card" id="configPanel" style="display:none;">
    <h2>On-Call Rotation <span class="badge" id="configDirty" style="display:none;background:#b45309;border:1px solid #f59e0b;">UNSAVED</span></h2>
    <label for="onCallSelect">Select On-Call Engineer</label>
    <select id="onCallSelect" class="input" style="height:44px;font-size:14px;padding:8px 12px;border-radius:12px;border:1px solid #ffbadb;background:#fff;">
      <option value="" disabled selected>Loading staff‚Ä¶</option>
    </select>
    <div style="margin-top:10px;font-size:12px;color:#7b1f54;" id="onCallDetails"></div>
    <div class="actions-line" style="margin-top:14px;">
      <button class="btn btn-primary" id="btnSaveConfig">Save</button>
      <button class="btn btn-ghost" id="btnShowConfig">Reload</button>
    </div>
    <small class="desc">Managers are excluded from selection. Saved choice becomes the active on-call contact.</small>
  </div>

  <!-- Who's On Call Panel -->
  <div class="panel card" id="onCallDisplayPanel" style="display:none;">
    <h2>Who's On Call <span class="badge" id="onCallBadge" style="background:#f97e0b;border-color:#fbbf24;">‚ö†</span></h2>
    <div id="onCallDisplay" style="padding:12px 0;font-size:14px;">Loading...</div>
    <div class="actions-line" style="margin-top:10px;">
      <button class="btn btn-ghost" id="btnRefreshOnCall">Refresh</button>
    </div>
  </div>

  <!-- Final Work Submissions Panel (Last Hour) -->
  <div class="panel card" id="finalWorkPanel" style="display:none;">
    <h2>Finished Exams (Last Hour) <span class="badge" id="finalWorkCount" style="background:#1e293b;border-color:#334155;">0</span></h2>
    <div style="overflow:auto;max-height:300px;border:1px solid #1e2533;border-radius:14px;">
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead style="background:#132033;position:sticky;top:0;">
          <tr>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Name</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Email</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Submitted</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #1f2d3d;">Time Used</th>
            <th style="padding:8px 10px;border-bottom:1px solid #1f2d3d;">Actions</th>
          </tr>
        </thead>
        <tbody id="finalWorkRows"></tbody>
      </table>
    </div>
    <div class="actions-line" style="margin-top:14px;">
      <button class="btn btn-ghost" id="btnReloadFinalWork">Refresh</button>
    </div>
  </div>

  <!-- Global maintenance panel removed per new per-candidate reset requirement -->
  <button type="button" class="floating-refresh" id="floatingRefresh" title="Refresh Candidates">‚ü≥ Refresh</button>

</main>
<!-- Modal for viewing candidate final work (answers) -->
<div id="answersModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:4000;align-items:flex-start;justify-content:center;padding:60px 20px;overflow:auto;">
  <div style="background:#ffffff;border:2px solid #ffb6dc;box-shadow:0 10px 40px -10px rgba(0,0,0,.35);border-radius:28px;max-width:860px;width:100%;padding:30px 34px;position:relative;">
    <button id="closeAnswersModal" style="position:absolute;top:12px;right:12px;background:#ffe3f1;border:1px solid #ffadd7;color:#a10d55;padding:4px 10px;font-size:12px;border-radius:20px;cursor:pointer;">Close</button>
    <h2 style="margin:0 0 14px;font-size:22px;color:#c91863;">Candidate Final Work</h2>
    <div id="answersModalMeta" style="font-size:12px;color:#7a1e52;margin-bottom:14px;font-family:ui-monospace,monospace;"></div>
    <div id="answersModalBody" class="readout" style="max-height:500px;overflow:auto;background:#fff;border:1px solid #ffd3e8;">Loading‚Ä¶</div>
  </div>
</div>

<!-- Modal for viewing session details -->
<div id="sessionModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:4000;align-items:flex-start;justify-content:center;padding:40px 20px;overflow:auto;">
  <div style="background:#ffffff;border:2px solid #ffb6dc;box-shadow:0 10px 40px -10px rgba(0,0,0,.35);border-radius:28px;max-width:1000px;width:100%;padding:30px 34px;position:relative;">
    <button id="closeSessionModal" style="position:absolute;top:12px;right:12px;background:#ffe3f1;border:1px solid #ffadd7;color:#a10d55;padding:4px 10px;font-size:12px;border-radius:20px;cursor:pointer;">Close</button>
    <h2 style="margin:0 0 14px;font-size:22px;color:#c91863;">Session Details</h2>
    <div id="sessionModalMeta" style="font-size:12px;color:#7a1e52;margin-bottom:14px;font-family:ui-monospace,monospace;"></div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
      <div>
        <h3 style="margin:0 0 8px;font-size:15px;color:#c91863;">Session Info</h3>
        <div id="sessionInfo" style="background:#fff4fa;border:1px solid #ffd3e8;border-radius:14px;padding:12px;font-size:11px;font-family:ui-monospace,monospace;"></div>
      </div>

    <div style="margin-bottom:20px;">
      <h3 style="margin:0 0 8px;font-size:15px;color:#c91863;">Answers</h3>
      <div id="sessionAnswers" class="readout" style="max-height:300px;overflow:auto;background:#fff;border:1px solid #ffd3e8;"></div>
    </div>

    <div>
      <h3 style="margin:0 0 8px;font-size:15px;color:#c91863;">Terminal Logs</h3>
      <div id="sessionTerminals" class="readout" style="max-height:250px;overflow:auto;background:#fff;border:1px solid #ffd3e8;"></div>
    </div>
    
    <div style="margin-top:20px;">
      <h3 style="margin:0 0 8px;font-size:15px;color:#c91863;">Live Activity <span id="liveActivityIndicator" style="font-size:11px;color:#059669;font-weight:normal;">(monitoring)</span></h3>
      <div id="liveActivityFeed" class="readout" style="max-height:200px;overflow:auto;background:#fff;border:1px solid #ffd3e8;font-size:11px;font-family:ui-monospace,monospace;">
        Waiting for candidate activity...
      </div>
    </div>
  </div>
</div>

<!-- Loading Modal for Exam Initialization -->
<div class="loading-modal" id="loadingModal">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div class="loading-text">Initializing Exam Environment</div>
    <div class="loading-subtext">Setting up isolated Docker containers with network configurations and troubleshooting scenarios...</div>
    <div class="loading-steps">
      <div class="loading-step active" id="step1">Cleaning up previous sessions</div>
      <div class="loading-step" id="step2">Creating isolated network</div>
      <div class="loading-step" id="step3">Spawning 13 containers</div>
      <div class="loading-step" id="step4">Installing tools and packages</div>
      <div class="loading-step" id="step5">Configuring WAF and upstream services</div>
      <div class="loading-step" id="step6">Applying network delays and disk simulations</div>
      <div class="loading-step" id="step7">Finalizing exam environment</div>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
// Admin page now expects cookie-based session established via /admin-login.html
// Still supports header fallback if needed (not used when cookie present)
let authToken=null;
// Minimal HTML escaper (was missing and caused candidate table to stay empty due to ReferenceError)
function escapeHtml(str){
  return String(str||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}
function gateFetch(url,opts={}){
  opts.headers = Object.assign(authToken? {'X-Admin-Password':authToken}: {}, opts.headers||{});
  return fetch(url, opts);
}
function showPanels(){
  document.getElementById('configPanel').style.display='block';
  document.getElementById('candidatesPanel').style.display='block';
  document.getElementById('finalWorkPanel').style.display='block';
}
async function verifySession(){
  console.log('[Admin] Verifying session...');
  // Try a cheap call that requires admin; use config endpoint
  try {
    const r = await gateFetch('/api/admin/config');
    console.log('[Admin] Config API response:', r.status, r.ok);
    const stateEl = document.getElementById('authState');
    const msgEl = document.getElementById('sessionMsg');
    const actions = document.getElementById('sessionActions');
    const btnLogin = document.getElementById('btnGoLogin');
    if(r.ok){
      console.log('[Admin] Authentication SUCCESS - showing panels');
      stateEl.textContent='ACTIVE';
      stateEl.style.background='#065f46';
      stateEl.style.border='1px solid #059669';
      msgEl.textContent='Session authenticated via cookie.';
      actions.style.display='flex';
      showPanels();
      loadConfig();
      loadCandidates();
      loadOnCallDisplay();
    } else {
      console.log('[Admin] Authentication FAILED - hiding panels');
      stateEl.textContent='NONE';
      stateEl.style.background='#7f1d1d';
      stateEl.style.border='1px solid #b91c1c';
      msgEl.innerHTML='No admin session. <strong>Use the Admin Login page.</strong>';
      actions.style.display='flex';
      document.getElementById('btnAdminLogout').style.display='none';
      btnLogin.style.display='inline-block';
    }
    document.getElementById('sessionPanel').style.display='block';
  } catch(e) {
    console.error('[Admin] verifySession error:', e);
  }
}
async function adminLogout(){
  await fetch('/api/auth/admin-logout',{method:'POST'});
  location.href='/admin-login.html';
}

const btnAdminLogout = document.getElementById('btnAdminLogout');
const btnGoLogin = document.getElementById('btnGoLogin');
if (btnAdminLogout) btnAdminLogout.addEventListener('click', adminLogout);
if (btnGoLogin) btnGoLogin.addEventListener('click', ()=> location.href='/admin-login.html');
verifySession();

// Config save
const onCallSelect=document.getElementById('onCallSelect');
const onCallDetails=document.getElementById('onCallDetails');
onCallSelect && onCallSelect.addEventListener('change',()=> {
  const configDirty = document.getElementById('configDirty');
  if (configDirty) configDirty.style.display='inline-block';
});

const btnSaveConfig = document.getElementById('btnSaveConfig');
if (btnSaveConfig) btnSaveConfig.addEventListener('click', async ()=>{
  const selected=onCallSelect.value;
  if(!selected){ alert('Select an on-call engineer'); return; }
  const body={recipients:'', onCall:selected};
  const r= await gateFetch('/api/admin/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(r.ok){ 
    const configDirty = document.getElementById('configDirty');
    if (configDirty) configDirty.style.display='none';
  }
});

const btnShowConfig = document.getElementById('btnShowConfig');
if (btnShowConfig) btnShowConfig.addEventListener('click', loadConfig);
async function loadConfig(){
  const rStaff = await gateFetch('/api/admin/staff');
  if(rStaff.ok){
    const data=await rStaff.json();
    const current=data.onCall||'';
    const list=(data.staff||[]).filter(s=> !s.manager);
    onCallSelect.innerHTML='<option disabled value="">Select engineer‚Ä¶</option>' + list.map(s=> '<option value="'+s.email+'">'+s.name+' ('+s.email.split('@')[0]+')</option>').join('');
    if(current){ onCallSelect.value=current; }
    const sel=list.find(s=> s.email===onCallSelect.value);
    if(sel){ onCallDetails.textContent=sel.email+' ‚Äî '+sel.phone; } else { onCallDetails.textContent=''; }
    onCallSelect.addEventListener('change',()=>{
      const ch=list.find(s=> s.email===onCallSelect.value); onCallDetails.textContent= ch? (ch.email+' ‚Äî '+ch.phone):'';
    });
    document.getElementById('configDirty').style.display='none';
  }
}

// Removed global reset logic

// Candidate list logic
async function loadCandidates(){
  await loadUploadsIndex();
  const r = await gateFetch('/api/admin/candidates');
  if(!r.ok) return; const j = await r.json();
  const active = j.candidates.filter(c=> !c.submittedAt);
  document.getElementById('candCount').textContent=active.length;
  const tbody=document.getElementById('candRows');
  tbody.innerHTML='';
  active.sort((a,b)=> (a.startTime?1:0)-(b.startTime?1:0) || (a.name||'').localeCompare(b.name||''));
  loadCandidatesWrapperData(active);
  active.forEach(c=>{
    const tr=document.createElement('tr');
    const emailLower=c.email.toLowerCase();
    const fileMap=uploadsByEmail[emailLower]||{};
    tr.innerHTML=
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;">'+escapeHtml(c.name||'')+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;font-family:ui-monospace,monospace;font-size:11px;">'+escapeHtml(c.email)+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;" data-rem="'+c.email+'">'+formatRemaining(c)+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;">'+(c.startTime? '<span style="font-size:10px;color:#b2497a;">‚Äî</span>' : '<button data-start="'+c.email+'" class="startBtn" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:4px 10px;border-radius:20px;font-size:11px;cursor:pointer;">Start</button>')+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;"><button data-reset="'+c.email+'" class="resetBtn" style="background:linear-gradient(135deg,#f97316,#fb923c);color:#fff;border:none;padding:4px 10px;border-radius:20px;font-size:11px;cursor:pointer;">Reset</button></td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;"><button data-delete="'+c.email+'" class="delBtn" title="Delete candidate" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;border:none;padding:4px 10px;border-radius:20px;font-size:11px;cursor:pointer;">Del</button></td>';
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('.startBtn').forEach(btn=> btn.addEventListener('click', async (e)=>{
    const email=e.target.getAttribute('data-start');
    if(!email){ alert('Email not found'); return; }
    
    // Show loading modal with step animation
    const modal = document.getElementById('loadingModal');
    modal.classList.add('show');
    
    // Animate through steps
    const steps = ['step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7'];
    let currentStep = 0;
    
    const stepInterval = setInterval(() => {
      if (currentStep > 0) {
        document.getElementById(steps[currentStep - 1]).classList.remove('active');
        document.getElementById(steps[currentStep - 1]).classList.add('done');
      }
      if (currentStep < steps.length) {
        document.getElementById(steps[currentStep]).classList.add('active');
        currentStep++;
      }
    }, 5000); // Update every 5 seconds
    
    try {
      const r2 = await gateFetch('/api/candidate/'+encodeURIComponent(email)+'/start',{method:'POST'});
      
      clearInterval(stepInterval);
      
      if(r2.ok){ 
        // Mark all steps as done
        steps.forEach(step => {
          document.getElementById(step).classList.remove('active');
          document.getElementById(step).classList.add('done');
        });
        
        // Wait a moment to show completion
        await new Promise(resolve => setTimeout(resolve, 800));
        modal.classList.remove('show');
        
        // Reset steps for next time
        setTimeout(() => {
          steps.forEach((step, idx) => {
            const el = document.getElementById(step);
            el.classList.remove('done', 'active');
            if (idx === 0) el.classList.add('active');
          });
        }, 500);
        
        alert('‚úÖ Exam started successfully for '+email+'!\n\nAll 13 containers are running with troubleshooting scenarios.');
        loadCandidates(); 
      }
      else { 
        modal.classList.remove('show');
        const errorData = await r2.json().catch(() => ({}));
        if(r2.status === 409) {
          alert('‚ö†Ô∏è Cannot start exam\\n\\nAnother candidate is currently taking the exam: ' + (errorData.runningCandidate || 'Unknown') + '\\n\\nOnly one candidate can take the exam at a time. Please wait for them to finish or manually end their exam.');
        } else {
          alert('Failed to start exam: ' + (errorData.error || 'Unknown error'));
        }
        // Reset steps
        steps.forEach((step, idx) => {
          const el = document.getElementById(step);
          el.classList.remove('done', 'active');
          if (idx === 0) el.classList.add('active');
        });
      }
    } catch (error) {
      clearInterval(stepInterval);
      modal.classList.remove('show');
      alert('Error starting exam: ' + error.message);
      // Reset steps
      steps.forEach((step, idx) => {
        const el = document.getElementById(step);
        el.classList.remove('done', 'active');
        if (idx === 0) el.classList.add('active');
      });
    }
  }));
  tbody.querySelectorAll('.resetBtn').forEach(btn=> btn.addEventListener('click', async e=>{
    const email=e.target.getAttribute('data-reset');
    if(!confirm('Reset candidate '+email+'?')) return;
    const r3=await gateFetch('/api/admin/candidate/'+encodeURIComponent(email)+'/reset',{method:'POST'});
    if(r3.ok) loadCandidates();
  }));
  // (Docx download buttons removed)
  tbody.querySelectorAll('.delBtn').forEach(btn=> btn.addEventListener('click', async e=>{
    const email=e.target.getAttribute('data-delete');
    if(!confirm('Delete candidate '+email+' and all their data?')) return;
    const r=await gateFetch('/api/admin/candidate/'+encodeURIComponent(email),{method:'DELETE'});
    if(r.ok) loadCandidates();
  }));
  tbody.querySelectorAll('[data-view]').forEach(btn=> btn.addEventListener('click', e=>{
    const email=e.target.getAttribute('data-view');
    openAnswersModal(email);
  }));
  tbody.querySelectorAll('[data-open]').forEach(btn=> btn.addEventListener('click', e=>{
    const email=e.target.getAttribute('data-open');
    window.open('/candidate-view.html?email='+encodeURIComponent(email),'_blank');
  }));
  tbody.querySelectorAll('[data-dl]').forEach(btn=> btn.addEventListener('click', e=>{
    const f=e.target.getAttribute('data-dl');
    if(f) window.open('/api/admin/uploads/'+encodeURIComponent(f),'_blank');
  }));
  startTimerUpdates();
  buildFinalWork(j.candidates);
}
function formatRemaining(c){
  if(!c.startTime) return 'Not started';
  const ms=c.remainingMs; const h=Math.floor(ms/3600000); const m=Math.floor((ms%3600000)/60000); const s=Math.floor((ms%60000)/1000);
  return `${h}h ${m}m ${s}s` + (c.extraTimeMs? ' (+extra)': '');
}
let timerInterval=null;
function startTimerUpdates(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    document.querySelectorAll('[data-rem]').forEach(cell=>{
      const email=cell.getAttribute('data-rem');
      const rowData = currentCandidates[email.toLowerCase()];
      if(!rowData) return;
      if(!rowData.startTime) return; // not started
      const rem=computeRemainingLocal(rowData);
      rowData.remainingMs=rem.remainingMs;
      cell.textContent=formatRemaining(rowData);
    });
  },1000);
}
// Lightweight compute on client mirroring server logic
function computeRemainingLocal(c){
  const base=4*60*60*1000;
  const extra=c.extraTimeMs||0;
  const total=base+extra;
  if(!c.startTime) return {remainingMs: total};
  const elapsed=Date.now()-c.startTime;
  return {remainingMs: Math.max(0,total-elapsed)};
}
let currentCandidates={};
function loadCandidatesWrapperData(list){
  currentCandidates={};
  list.forEach(c=> currentCandidates[c.email.toLowerCase()]=c);
}
// Uploaded final files index
let uploadsByEmail={};
async function loadUploadsIndex(){
  uploadsByEmail={};
  try {
    const r=await gateFetch('/api/admin/uploads');
    if(!r.ok) return; const j=await r.json();
    (j.files||[]).forEach(f=>{
      const m=/^([a-z0-9@._-]+)_(final|work)_(\d+)\.[a-z0-9]+$/i.exec(f.file);
      if(!m) return; const email=m[1].toLowerCase(); const kind=m[2]; const ts=parseInt(m[3],10);
      if(!uploadsByEmail[email]) uploadsByEmail[email]={};
      const slot = kind==='final'? 'pdf' : 'docx';
      const prev=uploadsByEmail[email][slot];
      if(!prev){ uploadsByEmail[email][slot]=f.file; }
      else {
        const pm=/_(final|work)_(\d+)\./.exec(prev); const prevTs=pm? parseInt(pm[2],10):0; if(ts>prevTs) uploadsByEmail[email][slot]=f.file;
      }
    });
  }catch(e){ /* ignore */ }
}
let candidatePollInterval=null;
function startCandidatePolling(){
  if(candidatePollInterval) clearInterval(candidatePollInterval);
  candidatePollInterval = setInterval(()=>{ loadCandidates(); }, 15000); // 15s
}
// Hook start after verification success (showPanels call)
const _origShowPanels = showPanels;
showPanels = function(){ _origShowPanels(); startCandidatePolling(); };

// ---- View-only answers modal ----
const answersModal = document.getElementById('answersModal');
const answersModalBody = document.getElementById('answersModalBody');
const answersModalMeta = document.getElementById('answersModalMeta');
document.getElementById('closeAnswersModal').addEventListener('click', ()=>{ answersModal.style.display='none'; });
answersModal.addEventListener('click', e=>{ if(e.target===answersModal) answersModal.style.display='none'; });

async function openAnswersModal(email){
  answersModal.style.display='flex';
  answersModalBody.textContent='Loading‚Ä¶';
  answersModalMeta.textContent='Candidate: '+email;
  try{
    // Try final snapshot first
    let ans = null; let submittedAt=null; let usedSnapshot=false;
    const rs = await gateFetch('/api/admin/candidate/'+encodeURIComponent(email)+'/final-work');
    if(rs.ok){
      const snap = await rs.json();
      if(snap && snap.snapshot){ ans = snap.snapshot.answers || {}; submittedAt=snap.submittedAt; usedSnapshot=true; }
    }
    if(!ans){
      const r = await gateFetch('/api/admin/candidate/'+encodeURIComponent(email)+'/answers');
      if(r.ok){ const j = await r.json(); ans = j.answers || {}; }
    }
    if(!ans || !Object.keys(ans).length){ answersModalBody.textContent='No answers yet.'; return; }
    const parts=[];
    if(submittedAt) parts.push('FINAL SUBMISSION at '+ new Date(submittedAt).toLocaleString() + (usedSnapshot? ' (snapshot)':'')+'\n');
    Object.entries(ans).forEach(([taskId,obj])=>{
      parts.push('### '+taskId+' (updated '+ new Date((obj && obj.updatedAt)||0).toLocaleString()+')');
      const fields=(obj && obj.fields)||{};
      Object.entries(fields).forEach(([k,v])=>{
        parts.push('\n'+k+':');
        let val = typeof v==='string'? v: JSON.stringify(v);
        val = val.replace(/<[^>]+>/g,'');
        parts.push(val.trim()? '  '+val.trim(): '  (empty)');
      });
      parts.push('\n');
    });
    answersModalBody.textContent=parts.join('\n');
  }catch(e){ answersModalBody.textContent='Error: '+e.message; }
}

// ---- On Call Display Logic ----
async function loadOnCallDisplay(){
  const panel = document.getElementById('onCallDisplayPanel');
  const display = document.getElementById('onCallDisplay');
  const badge = document.getElementById('onCallBadge');
  
  try {
    const r = await gateFetch('/api/admin/staff');
    if(!r.ok) throw new Error('Failed to load');
    const data = await r.json();
    const staff = data.staff || [];
    const onCallEmail = data.onCall || '';
    
    if(onCallEmail) {
      const person = staff.find(s => s.email === onCallEmail);
      display.innerHTML = '<div style="background:#eff6ff;padding:16px 20px;border-radius:16px;border:1px solid #3b82f6;">' +
        '<strong style="font-size:18px;color:#1e40af;display:block;margin-bottom:8px;">üìû ' + (person ? person.name : onCallEmail) + '</strong>' +
        (person ? '<span style="font-size:14px;color:#3b82f6;">Phone: ' + person.phone + '</span><br>' : '') +
        '<span style="font-size:12px;color:#64748b;">' + onCallEmail + '</span>' +
        '</div>';
      badge.textContent = '‚úì';
      badge.style.background = '#10b981';
      badge.style.borderColor = '#34d399';
    } else {
      display.innerHTML = '<div style="background:#fef3c7;padding:16px 20px;border-radius:16px;border:1px solid #f59e0b;">' +
        '<strong style="font-size:16px;color:#b45309;">‚ö†Ô∏è No one is currently on call</strong>' +
        '</div>';
      badge.textContent = '‚ö†';
      badge.style.background = '#f97e0b';
      badge.style.borderColor = '#fbbf24';
    }
    panel.style.display = 'block';
  } catch(e) {
    display.innerHTML = '<p style="color:#dc2626;">Failed to load on-call info</p>';
    panel.style.display = 'block';
  }
}

const btnRefreshOnCall = document.getElementById('btnRefreshOnCall');
if(btnRefreshOnCall) btnRefreshOnCall.addEventListener('click', loadOnCallDisplay);

// ---- Final Work Panel Logic ----
function buildFinalWork(candidates){
  // Filter to only show exams finished/submitted in the last hour
  const oneHourAgo = Date.now() - (60 * 60 * 1000);
  const submitted = candidates.filter(c => {
    const finishTime = c.submittedAt || c.finishedAt || c.expiredAt;
    return finishTime && finishTime >= oneHourAgo;
  });
  const tbody = document.getElementById('finalWorkRows');
  const countEl = document.getElementById('finalWorkCount');
  if (!tbody || !countEl) {
    console.warn('[Admin] Final work elements not found in DOM');
    return;
  }
  countEl.textContent=submitted.length;
  tbody.innerHTML='';
  submitted.sort((a,b)=> a.submittedAt - b.submittedAt);
  submitted.forEach(c=>{
    const usedMs = c.submittedAt - (c.startTime||c.submittedAt);
    const h=Math.floor(usedMs/3600000); const m=Math.floor((usedMs%3600000)/60000); const s=Math.floor((usedMs%60000)/1000);
    const tr=document.createElement('tr');
    const emailLower=c.email.toLowerCase();
    const fileMap = (typeof uploadsByEmail!=='undefined' && uploadsByEmail[emailLower]) ? uploadsByEmail[emailLower] : {};
    const pdfBtn = fileMap.pdf ? '<button data-dl-final="'+fileMap.pdf+'" style="background:#047857;color:#fff;border:none;padding:4px 8px;border-radius:14px;font-size:10px;cursor:pointer;">PDF</button>' : '<span style="font-size:10px;color:#b2497a;">‚Äî</span>';
    const docxBtn = fileMap.docx ? '<button data-dl-final="'+fileMap.docx+'" style="background:#475569;color:#fff;border:none;padding:4px 8px;border-radius:14px;font-size:10px;cursor:pointer;">DOCX</button>' : '';
    tr.innerHTML=
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;">'+escapeHtml(c.name||'')+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;font-family:ui-monospace,monospace;font-size:11px;">'+escapeHtml(c.email)+'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;">'+ new Date(c.submittedAt).toLocaleString() +'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;">'+h+'h '+m+'m '+s+'s</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;display:flex;gap:4px;justify-content:center;">'+pdfBtn+ (docxBtn? ' '+docxBtn:'') +'</td>'+
      '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;"><button data-view-final="'+c.email+'" style="background:linear-gradient(135deg,#9333ea,#6d28d9);color:#fff;border:none;padding:4px 10px;border-radius:18px;font-size:11px;cursor:pointer;">View</button> <button data-open-final="'+c.email+'" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;border:none;padding:4px 10px;border-radius:18px;font-size:11px;cursor:pointer;">Open</button></td>';
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('[data-view-final]').forEach(btn=> btn.addEventListener('click', e=>{
    const email=e.target.getAttribute('data-view-final');
    openAnswersModal(email);
  }));
  tbody.querySelectorAll('[data-open-final]').forEach(btn=> btn.addEventListener('click', e=>{
    const email=e.target.getAttribute('data-open-final');
    window.open('/candidate-view.html?email='+encodeURIComponent(email),'_blank');
  }));
  tbody.querySelectorAll('[data-dl-final]').forEach(btn=> btn.addEventListener('click', e=>{
    const file=e.target.getAttribute('data-dl-final');
    if(file) window.open('/api/admin/uploads/'+encodeURIComponent(file),'_blank');
  }));
}

// ---- Candidate Management Buttons ----
const btnReloadFinalWork = document.getElementById('btnReloadFinalWork');
const btnReloadCandidates = document.getElementById('btnReloadCandidates');
const floatingRefresh = document.getElementById('floatingRefresh');
const btnShowCreate = document.getElementById('btnShowCreate');

if (btnReloadFinalWork) btnReloadFinalWork.addEventListener('click', ()=> loadCandidates());
if (btnReloadCandidates) btnReloadCandidates.addEventListener('click', ()=> loadCandidates());
if (floatingRefresh) floatingRefresh.addEventListener('click', ()=> loadCandidates());

if (btnShowCreate) btnShowCreate.addEventListener('click', ()=>{
  const form = document.getElementById('createCandidateForm');
  if (form) form.style.display='block';
});

const btnCancelCreate = document.getElementById('btnCancelCreate');
if (btnCancelCreate) btnCancelCreate.addEventListener('click', ()=>{
  const form = document.getElementById('createCandidateForm');
  const nameInput = document.getElementById('newCandName');
  const emailInput = document.getElementById('newCandEmail');
  if (form) form.style.display='none';
  if (nameInput) nameInput.value='';
  if (emailInput) emailInput.value='';
});

const createCandidateForm = document.getElementById('createCandidateForm');
if (createCandidateForm) createCandidateForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name=document.getElementById('newCandName').value.trim();
  const email=document.getElementById('newCandEmail').value.trim();
  if(!email){ alert('Email required'); return; }
  try {
    const r=await gateFetch('/api/admin/candidate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email})});
    if(r.ok){
      alert('Candidate created successfully');
      document.getElementById('createCandidateForm').style.display='none';
      document.getElementById('newCandName').value='';
      document.getElementById('newCandEmail').value='';
      loadCandidates();
    } else {
      const err=await r.json().catch(()=>({error:'Unknown error'}));
      alert('Failed to create candidate: '+(err.error||'Unknown error'));
    }
  } catch(e){
    alert('Error creating candidate: '+e.message);
  }
});

const btnCreateAndOpen = document.getElementById('btnCreateAndOpen');
if (btnCreateAndOpen) btnCreateAndOpen.addEventListener('click', async ()=>{
  const nameInput = document.getElementById('newCandName');
  const emailInput = document.getElementById('newCandEmail');
  if (!nameInput || !emailInput) return;
  const name=nameInput.value.trim();
  const email=emailInput.value.trim();
  if(!email){ alert('Email required'); return; }
  try {
    const r=await gateFetch('/api/admin/candidate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email})});
    if(r.ok){
      alert('Candidate created successfully');
      document.getElementById('createCandidateForm').style.display='none';
      document.getElementById('newCandName').value='';
      document.getElementById('newCandEmail').value='';
      loadCandidates();
      window.open('/login.html?email='+encodeURIComponent(email)+'&name='+encodeURIComponent(name),'_blank');
    } else {
      const err=await r.json().catch(()=>({error:'Unknown error'}));
      alert('Failed to create candidate: '+(err.error||'Unknown error'));
    }
  } catch(e){
    alert('Error creating candidate: '+e.message);
  }
});

const btnDeleteAll = document.getElementById('btnDeleteAll');
if (btnDeleteAll) btnDeleteAll.addEventListener('click', async ()=>{
  if(!confirm('Delete ALL candidates and their data? This cannot be undone!')) return;
  try {
    const r=await gateFetch('/api/admin/candidates/all',{method:'DELETE'});
    if(r.ok){
      const j=await r.json();
      alert('Deleted '+j.deleted+' candidate(s)');
      loadCandidates();
    } else {
      const err=await r.json().catch(()=>({error:'Unknown error'}));
      alert('Failed to delete candidates: '+(err.error||'Unknown error'));
    }
  } catch(e){
    alert('Error deleting candidates: '+e.message);
  }
});

</script>
</body>
</html>
  const form=document.getElementById('templateUploadForm');
  const metaEl=document.getElementById('templateMeta');
  const reloadBtn=document.getElementById('btnReloadTemplate');
  if(!form || !metaEl) return;
  async function loadTemplate(){
    try{
      const r=await gateFetch('/api/admin/exam-template');
      if(!r.ok){ metaEl.textContent='Failed to load template status.'; return; }
      const j=await r.json();
      if(!j.template){ metaEl.textContent='No template uploaded yet.'; return; }
      metaEl.innerHTML='Current: <strong>'+escapeHtml(j.template.originalName||'exam_template.docx')+'</strong> uploaded '+ new Date(j.template.uploadedAt).toLocaleString()+'. <a href="/exam-template/download" target="_blank">Download</a>';
    }catch(e){ metaEl.textContent='Error loading template.'; }
  }
  form.addEventListener('submit', async e=>{
    e.preventDefault();
    const file=document.getElementById('templateFile').files[0];
    if(!file){ alert('Select a DOCX file'); return; }
    if(file.size > 10*1024*1024){ alert('File exceeds 10MB limit'); return; }
    const btn=form.querySelector('button[type=submit]');
    btn.disabled=true; btn.textContent='Uploading...';
    try{
      const fd=new FormData(); fd.append('template', file);
      const r=await gateFetch('/api/admin/exam-template',{method:'POST',body:fd});
      if(!r.ok){ alert('Upload failed ('+r.status+')'); btn.disabled=false; btn.textContent='Upload / Replace'; return; }
      await loadTemplate();
    }catch(err){ alert('Network error'); }
    btn.disabled=false; btn.textContent='Upload / Replace';
    form.reset();
  });
  reloadBtn && reloadBtn.addEventListener('click', e=>{ e.preventDefault(); loadTemplate(); });
  // Defer initial load until session verified triggers showPanels; poll for existence
  let tries=0; const int=setInterval(()=>{ if(metaEl.offsetParent!==null){ clearInterval(int); loadTemplate(); } if(++tries>40) clearInterval(int); },250);
})();

// ---- Session Browser Panel Logic ----
async function loadSessions(){
  try{
    const r = await gateFetch('/api/admin/sessions');
    if(!r.ok){ console.error('Failed to load sessions'); return; }
    const data = await r.json();
    const sessions = data.sessions || [];
    
    document.getElementById('sessionCount').textContent = sessions.length;
    const tbody = document.getElementById('sessionRows');
    tbody.innerHTML = '';
    
    if(sessions.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="7" style="padding:20px;text-align:center;color:#b2497a;">No sessions yet. Sessions are created when candidates start their exams.</td>';
      tbody.appendChild(tr);
      return;
    }
    
    // Sort by creation time, newest first
    sessions.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
    
    sessions.forEach(session=>{
      const tr = document.createElement('tr');
      const sessionId = session.sessionId || 'unknown';
      const email = session.candidateEmail || 'N/A';
      const status = session.status || 'unknown';
      const created = session.createdAt ? new Date(session.createdAt).toLocaleString() : 'N/A';
      const completed = session.completedAt ? new Date(session.completedAt).toLocaleString() : '‚Äî';
      const containerCount = (session.containers || []).length;
      const isActive = status === 'active';
      
      // Status badge
      let statusBadge = '';
      if(status === 'active'){
        statusBadge = '<span style="background:#065f46;border:1px solid #059669;color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;">ACTIVE</span>';
      } else if(status === 'completed'){
        statusBadge = '<span style="background:#7c2d12;border:1px solid #c2410c;color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;">COMPLETED</span>';
      } else {
        statusBadge = '<span style="background:#475569;border:1px solid #64748b;color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;">'+escapeHtml(status.toUpperCase())+'</span>';
      }
      
      tr.innerHTML = 
        '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;font-family:ui-monospace,monospace;font-size:10px;" title="'+escapeHtml(sessionId)+'">'+escapeHtml(sessionId.substring(0,12))+'...</td>'+
        '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;font-family:ui-monospace,monospace;font-size:11px;">'+escapeHtml(email)+'</td>'+
        '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;">'+statusBadge+'</td>'+
        '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;font-size:10px;">'+created+'</td>'+
        '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;font-size:10px;">'+completed+'</td>'+
        '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;">'+
          (isActive ? '<span style="color:#059669;">'+containerCount+' running</span>' : '<span style="color:#b2497a;">‚Äî</span>')+
        '</td>'+
        '<td style="padding:6px 10px;border-bottom:1px solid #ffd3e8;text-align:center;">'+
          '<button data-view-session="'+escapeHtml(sessionId)+'" style="background:linear-gradient(135deg,#9333ea,#6d28d9);color:#fff;border:none;padding:4px 10px;border-radius:18px;font-size:11px;cursor:pointer;">View</button>'+
          (isActive ? ' <button data-snapshot-session="'+escapeHtml(sessionId)+'" style="background:linear-gradient(135deg,#f97316,#fb923c);color:#fff;border:none;padding:4px 8px;border-radius:18px;font-size:11px;cursor:pointer;" title="Create snapshot">üì∏</button>' : '')+
        '</td>';
      tbody.appendChild(tr);
    });
    
    // Attach event listeners
    tbody.querySelectorAll('[data-view-session]').forEach(btn=> btn.addEventListener('click', async e=>{
      const sessionId = e.target.getAttribute('data-view-session');
      await openSessionModal(sessionId);
    }));
    
    tbody.querySelectorAll('[data-snapshot-session]').forEach(btn=> btn.addEventListener('click', async e=>{
      const sessionId = e.target.getAttribute('data-snapshot-session');
      if(!confirm('Create snapshot for session '+sessionId+'?\nThis will export all container states.')) return;
      try{
        const r = await gateFetch('/api/session/'+encodeURIComponent(sessionId)+'/snapshot', {method:'POST'});
        if(r.ok){
          alert('Snapshot created successfully!');
          loadSessions();
        } else {
          alert('Snapshot failed: '+(await r.text()));
        }
      }catch(err){
        alert('Network error: '+err.message);
      }
    }));
    
  }catch(e){
    console.error('Error loading sessions:', e);
  }
}

document.getElementById('btnReloadSessions').addEventListener('click', ()=> loadSessions());

// ---- Session Details Modal ----
const sessionModal = document.getElementById('sessionModal');
const sessionModalMeta = document.getElementById('sessionModalMeta');
const sessionInfo = document.getElementById('sessionInfo');
const sessionContainers = document.getElementById('sessionContainers');
const sessionAnswers = document.getElementById('sessionAnswers');
const sessionTerminals = document.getElementById('sessionTerminals');
const liveActivityFeed = document.getElementById('liveActivityFeed');
const liveActivityIndicator = document.getElementById('liveActivityIndicator');

let currentSocket = null;
let currentSessionId = null;

document.getElementById('closeSessionModal').addEventListener('click', ()=>{ 
  sessionModal.style.display='none';
  if(currentSocket){
    currentSocket.disconnect();
    currentSocket = null;
  }
});
sessionModal.addEventListener('click', e=>{ 
  if(e.target===sessionModal){
    sessionModal.style.display='none';
    if(currentSocket){
      currentSocket.disconnect();
      currentSocket = null;
    }
  }
});

function appendLiveActivity(message, type){
  const timestamp = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.style.padding = '4px 0';
  line.style.borderBottom = '1px solid #ffd3e8';
  
  const colors = {
    'answer-saved': '#059669',
    'terminal-activity': '#0284c7',
    'connected': '#7c3aed'
  };
  
  line.innerHTML = `<span style="color:#94a3b8;">[${timestamp}]</span> <span style="color:${colors[type] || '#64748b'};font-weight:600;">${type}</span>: ${message}`;
  liveActivityFeed.appendChild(line);
  liveActivityFeed.scrollTop = liveActivityFeed.scrollHeight;
}

async function openSessionModal(sessionId){
  currentSessionId = sessionId;
  sessionModal.style.display='flex';
  sessionModalMeta.textContent = 'Loading session: '+sessionId;
  sessionInfo.textContent = 'Loading...';
  sessionContainers.textContent = 'Loading...';
  sessionAnswers.textContent = 'Loading...';
  sessionTerminals.textContent = 'Loading...';
  liveActivityFeed.innerHTML = '<span style="color:#94a3b8;">Connecting to live feed...</span>';
  
  // Connect to socket.io for live updates
  if(currentSocket){
    currentSocket.disconnect();
  }
  
  try{
    currentSocket = io({
      path: '/ws',
      query: { sessionId: sessionId }
    });
    
    currentSocket.on('connected', (data)=>{
      liveActivityIndicator.textContent = '(connected)';
      liveActivityIndicator.style.color = '#059669';
      liveActivityFeed.innerHTML = '<span style="color:#059669;">‚úì Connected to session '+sessionId+'</span>';
    });
    
    currentSocket.on('sessionUpdate', (update)=>{
      const { eventType, data } = update;
      
      if(eventType === 'answer-saved'){
        appendLiveActivity(`Task "${data.taskId}" saved (${data.fieldCount} fields)`, 'answer-saved');
        // Refresh answers section
        loadSessionAnswers(sessionId);
      }
      else if(eventType === 'terminal-activity'){
        appendLiveActivity(`Terminal activity in ${data.container}`, 'terminal-activity');
      }
    });
    
    currentSocket.on('disconnect', ()=>{
      liveActivityIndicator.textContent = '(disconnected)';
      liveActivityIndicator.style.color = '#dc2626';
    });
  }catch(e){
    console.error('Socket.io connection failed:', e);
    liveActivityFeed.innerHTML = '<span style="color:#dc2626;">Failed to connect to live feed</span>';
  }
  
  try{
    const r = await gateFetch('/api/admin/session/'+encodeURIComponent(sessionId)+'/details');
    if(!r.ok){
      sessionInfo.textContent = 'Failed to load session details: '+r.status;
      return;
    }
    
    const details = await r.json();
    
    // Session info
    sessionModalMeta.textContent = 'Session: '+sessionId;
    const meta = details.metadata || {};
    const infoLines = [];
    infoLines.push('Candidate: '+(meta.candidateEmail || 'N/A'));
    infoLines.push('Status: '+(meta.status || 'unknown'));
    infoLines.push('Created: '+(meta.createdAt ? new Date(meta.createdAt).toLocaleString() : 'N/A'));
    if(meta.completedAt) infoLines.push('Completed: '+new Date(meta.completedAt).toLocaleString());
    if(meta.snapshotAt) infoLines.push('Snapshot: '+new Date(meta.snapshotAt).toLocaleString());
    sessionInfo.textContent = infoLines.join('\n');
    
    // Containers
    const containers = meta.containers || [];
    if(containers.length > 0){
      sessionContainers.textContent = containers.join('\n');
    } else {
      sessionContainers.textContent = 'No containers (session cleaned up)';
    }
    
    // Answers
    loadSessionAnswers(sessionId, details.answers);
    
    // Terminal logs
    const terminalLogs = details.terminalLogs || {};
    if(Object.keys(terminalLogs).length === 0){
      sessionTerminals.textContent = 'No terminal logs saved.';
    } else {
      const termLines = [];
      Object.entries(terminalLogs).forEach(([terminalId, history])=>{
        termLines.push('‚ïê‚ïê‚ïê '+terminalId+' ‚ïê‚ïê‚ïê');
        if(Array.isArray(history) && history.length > 0){
          history.forEach(entry=>{
            termLines.push('['+new Date(entry.timestamp).toLocaleTimeString()+'] '+entry.command);
          });
        } else {
          termLines.push('(no commands recorded)');
        }
        termLines.push('');
      });
      sessionTerminals.textContent = termLines.join('\n');
    }
    
  }catch(e){
    sessionInfo.textContent = 'Error: '+e.message;
  }
}

async function loadSessionAnswers(sessionId, answersData){
  try{
    let answers = answersData;
    if(!answers){
      const r = await gateFetch('/api/admin/session/'+encodeURIComponent(sessionId)+'/details');
      if(r.ok){
        const details = await r.json();
        answers = details.answers || {};
      }
    }
    
    const sessionAnswers = document.getElementById('sessionAnswers');
    if(!answers || Object.keys(answers).length === 0){
      sessionAnswers.textContent = 'No answers saved yet.';
      return;
    }
    
    const answerLines = [];
    Object.entries(answers).forEach(([taskId, answerData])=>{
      answerLines.push('‚ïê‚ïê‚ïê '+taskId+' ‚ïê‚ïê‚ïê');
      answerLines.push('Saved: '+(answerData.savedAt ? new Date(answerData.savedAt).toLocaleString() : 'unknown'));
      if(answerData.answer && typeof answerData.answer === 'object'){
        const fields = answerData.answer.fields || answerData.answer;
        Object.entries(fields).forEach(([key, value])=>{
          answerLines.push('');
          answerLines.push(key+':');
          let val = typeof value === 'string' ? value : JSON.stringify(value);
          val = val.replace(/<[^>]+>/g, ''); // Strip HTML
          answerLines.push(val.trim() || '  (empty)');
        });
      }
      answerLines.push('');
    });
    sessionAnswers.textContent = answerLines.join('\n');
  }catch(e){
    console.error('Failed to load session answers:', e);
  }
}

</script>
<script>
// Admin realtime logic (SSE only unless USE_WS server flag set)
(function(){
  const sidInput=document.getElementById('rtSessionId');
  const btnConnect=document.getElementById('btnRtConnect');
  const btnDisconnect=document.getElementById('btnRtDisconnect');
  const statusEl=document.getElementById('rtStatus');
  const eventsEl=document.getElementById('rtEvents');
  const summaryEl=document.getElementById('rtSummary');
  let es=null; let answersCache={};
  function setStatus(txt,color){ statusEl.textContent=txt; if(color){ statusEl.style.background=color.bg; statusEl.style.borderColor=color.border; }}
  function appendEvent(line){ const pre=document.createElement('div'); pre.style.padding='2px 0'; pre.textContent=line; eventsEl.appendChild(pre); eventsEl.scrollTop=eventsEl.scrollHeight; }
  function renderSummary(){ summaryEl.innerHTML=Object.keys(answersCache).length? Object.entries(answersCache).map(([task,v])=>`<div style="background:#fff4fa;border:1px solid #ffb5da;padding:10px 12px;border-radius:14px;font-size:11px;display:flex;flex-direction:column;gap:4px;"><strong style="font-size:11px;letter-spacing:.08em;">${task}</strong><span style="font-family:ui-monospace,monospace;">v${v.version} @ ${new Date(v.updated_at).toLocaleTimeString()}</span></div>`).join('') : '<div style="font-size:11px;color:#b2497a;">No answers yet.</div>'; }
  async function primeAnswers(sessionId){ try{ const r=await fetch('/api/sessions/'+encodeURIComponent(sessionId)+'/answers'); if(!r.ok) return; const j=await r.json(); answersCache={}; (j.answers||[]).forEach(a=>{ answersCache[a.task_id]={version:a.version,updated_at:a.updated_at}; }); renderSummary(); }catch(e){} }
  function connect(){ const sid=(sidInput.value||'').trim(); if(!sid) return alert('Enter session id'); if(es){ es.close(); }
    primeAnswers(sid);
    es=new EventSource('/api/sessions/'+encodeURIComponent(sid)+'/stream');
    setStatus('OPEN',{bg:'#065f46',border:'#059669'}); btnConnect.style.display='none'; btnDisconnect.style.display='inline-block'; appendEvent('Connected to '+sid);
    es.addEventListener('answer_updated', ev=>{ try{ const data=JSON.parse(ev.data); answersCache[data.task_id]={version:data.version,updated_at:data.updated_at}; renderSummary(); appendEvent('answer_updated '+data.task_id+' v'+data.version); }catch(_e){} });
    es.addEventListener('event_logged', ev=>{ appendEvent('event '+ev.data); });
    es.onerror=()=>{ appendEvent('stream error'); setStatus('ERR',{bg:'#7f1d1d',border:'#b91c1c'}); };
  }
  function disconnect(){ if(es){ es.close(); es=null; } setStatus('IDLE',{bg:'#1e293b',border:'#334155'}); btnConnect.style.display='inline-block'; btnDisconnect.style.display='none'; appendEvent('Disconnected'); }
  btnConnect && btnConnect.addEventListener('click', connect); btnDisconnect && btnDisconnect.addEventListener('click', disconnect);
})();
</script>
</body>
</html>